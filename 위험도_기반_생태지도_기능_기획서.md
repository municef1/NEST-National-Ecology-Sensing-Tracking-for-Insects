# 위험도 기반 생태지도 기능 기획서

## 📋 프로젝트 개요

**프로젝트명**: NEST 곤충생태지도 - 위험도 기반 시각화 기능  
**목적**: 곤충 탐지 및 분류 결과의 위험도 정보를 지도에 시각적으로 표시하여 지역별 위험 곤충 분포를 한눈에 파악할 수 있도록 함  
**대상 사용자**: 일반 시민, 연구자, 환경 보호 기관, 지자체

---

## 🎯 핵심 목표

1. **위험도 기반 마커 표시**: 위험도 등급에 따라 마커 색상 및 아이콘 변경
2. **필터링 기능**: 위험도 등급별로 지도 마커 필터링
3. **통계 대시보드**: 지역별 위험도 통계 및 히트맵 표시
4. **경고 알림**: 위험도 높은 지역에 대한 시각적 경고 표시

---

## 📊 위험도 등급 체계

현재 시스템의 위험도 등급을 활용:

| 등급 | 이름 | 색상 | 점수 범위 | 설명 |
|------|------|------|-----------|------|
| **CRITICAL** | 매우 위험 | 🔴 #F44336 | 4.0 ~ 5.0 | 사망 위험, 즉시 대피 필요 |
| **DANGER** | 위험 | 🟠 #FF9800 | 3.0 ~ 4.0 | 심각한 부상 위험, 주의 필요 |
| **CAUTION** | 주의 | 🟡 #FFC107 | 1.5 ~ 3.0 | 경미한 부상 가능, 관찰 필요 |
| **SAFE** | 안전 | 🟢 #4CAF50 | 0.0 ~ 1.5 | 안전, 관찰 가능 |
| **UNKNOWN** | 정보 없음 | ⚪ #9E9E9E | - | 위험도 정보 없음 |

---

## 🗺️ 기능 상세 설계

### 1. 위험도 기반 마커 시각화

#### 1.1 마커 색상 및 아이콘
- **CRITICAL (매우 위험)**
  - 색상: 빨간색 (#F44336)
  - 아이콘: ⚠️ 또는 🔴
  - 크기: 48px (다른 등급보다 크게)
  - 애니메이션: 펄스 효과 (깜빡임)
  
- **DANGER (위험)**
  - 색상: 주황색 (#FF9800)
  - 아이콘: ⚠️
  - 크기: 40px
  
- **CAUTION (주의)**
  - 색상: 노란색 (#FFC107)
  - 아이콘: ⚠️
  - 크기: 36px
  
- **SAFE (안전)**
  - 색상: 초록색 (#4CAF50)
  - 아이콘: ✓ 또는 🟢
  - 크기: 32px
  
- **UNKNOWN (정보 없음)**
  - 색상: 회색 (#9E9E9E)
  - 아이콘: ❓
  - 크기: 32px

#### 1.2 마커 클러스터링
- 같은 위험도 등급의 마커들이 가까이 있을 때 자동으로 클러스터링
- 클러스터 아이콘에 위험도 등급 색상 적용
- 클러스터 클릭 시 확대하여 개별 마커 표시

### 2. 필터링 기능

#### 2.1 위험도 등급 필터
```
[전체] [매우 위험] [위험] [주의] [안전] [정보 없음]
```
- 체크박스 또는 토글 버튼으로 구현
- 선택한 등급의 마커만 지도에 표시
- 다중 선택 가능

#### 2.2 날짜 범위 필터
- 날짜 선택기로 특정 기간의 데이터만 표시
- "최근 7일", "최근 30일", "최근 1년" 등 빠른 선택 옵션

#### 2.3 지역 필터
- 시/도, 시/군/구 선택 드롭다운
- 선택한 지역의 마커만 표시

### 3. 통계 대시보드

#### 3.1 위험도 통계 카드
기존 통계 카드에 추가:
- **위험도별 개수**
  - 매우 위험: X개
  - 위험: X개
  - 주의: X개
  - 안전: X개
  - 정보 없음: X개

#### 3.2 지역별 위험도 분포
- 시/도별 위험도 통계 표
- 위험도 높은 지역 TOP 5 표시
- 위험도 낮은 지역 TOP 5 표시

#### 3.3 시간대별 위험도 추이
- 월별/계절별 위험 곤충 출현 통계
- 그래프로 시각화 (선 그래프 또는 막대 그래프)

### 4. 히트맵 기능

#### 4.1 위험도 히트맵
- 위험도 높은 지역을 색상으로 강조
- CRITICAL: 진한 빨간색
- DANGER: 주황색
- CAUTION: 노란색
- SAFE: 초록색

#### 4.2 밀도 히트맵
- 곤충 출현 빈도에 따른 밀도 표시
- 출현 빈도가 높은 지역을 진한 색으로 표시

### 5. 경고 및 알림 기능

#### 5.1 위험 지역 경고
- CRITICAL 등급 마커가 있는 지역에 경고 배너 표시
- "⚠️ 이 지역에 매우 위험한 곤충이 탐지되었습니다"

#### 5.2 팝업 정보 강화
- 마커 클릭 시 표시되는 팝업에 위험도 정보 추가
- 위험도 배지, 대응 가이드, 응급처치 정보 포함

---

## 💾 데이터 구조 설계

### 분류 정보 저장 확장
현재 `classification_storage`에 위험도 정보 추가:

```json
{
  "filename": "image_123.jpg",
  "order": "벌목",
  "family": "말벌과",
  "genus": "장수말벌속",
  "species": "Vespa mandarinia",
  "korean_name": "장수말벌",
  "confidence_scores": {
    "order": 0.95,
    "family": 0.92,
    "genus": 0.88,
    "species": 0.85
  },
  "risk_assessment": {
    "risk_level": "critical",
    "risk_level_name": "매우 위험",
    "risk_level_color": "#F44336",
    "risk_score": 5.0,
    "description": "연평균 10명 이상 사망",
    "warnings": ["즉시 대피", "119 신고"],
    "response_guide": {
      "prevention": ["접촉 금지", "안전 거리 유지"],
      "emergency": ["119 신고", "의료진 호출"]
    }
  },
  "location": {
    "lat": 37.5665,
    "lon": 126.9780,
    "address": "서울특별시 중구"
  },
  "timestamp": "2024-01-15T10:30:00"
}
```

---

## 🎨 UI/UX 디자인

### 1. 필터 패널
- 지도 상단 또는 좌측에 고정 패널
- 토스 스타일의 깔끔한 디자인
- 토글 버튼으로 접기/펼치기 가능

### 2. 통계 카드 개선
- 위험도별 카드에 색상 배경 적용
- 아이콘과 숫자 강조
- 호버 시 상세 정보 툴팁 표시

### 3. 마커 팝업 개선
- 위험도 배지 상단에 표시
- 위험도에 따른 경고 메시지 강조
- 대응 가이드 버튼 추가

### 4. 반응형 디자인
- 모바일에서는 필터 패널을 하단 시트로 표시
- 터치 제스처로 필터 조작 가능

---

## 🔧 기술 구현 방안

### 1. 백엔드 (Flask)

#### 1.1 위험도 정보 추가
```python
# app.py의 map_page() 함수 수정
@app.route("/map")
def map_page():
    locations = extract_locations_from_folder(app.config["UPLOAD_FOLDER"])
    storage = get_classification_storage()
    classifications = storage.get_all_classifications()
    risk_assessor = get_risk_assessor_instance()
    
    for loc in locations:
        filename = loc['filename']
        if filename in classifications:
            loc['classification'] = classifications[filename]
            # 위험도 정보 추가
            species = classifications[filename].get('species', '')
            if species:
                risk_result = risk_assessor.assess_risk(species)
                if risk_result:
                    loc['risk_assessment'] = risk_result
                else:
                    loc['risk_assessment'] = {
                        'risk_level': 'unknown',
                        'risk_level_name': '정보 없음',
                        'risk_level_color': '#9E9E9E'
                    }
    
    return render_template("map.html", 
                         locations=locations, 
                         total_images=total_images)
```

#### 1.2 필터링 API
```python
@app.route("/api/map/filter", methods=["POST"])
def filter_map_data():
    data = request.get_json()
    risk_levels = data.get('risk_levels', [])
    date_range = data.get('date_range', {})
    
    # 필터링 로직
    filtered_locations = filter_locations_by_risk(
        locations, risk_levels, date_range
    )
    
    return jsonify({'locations': filtered_locations})
```

### 2. 프론트엔드 (JavaScript/Leaflet)

#### 2.1 위험도별 마커 생성
```javascript
function createRiskMarker(location, index) {
    const riskLevel = location.risk_assessment?.risk_level || 'unknown';
    const riskConfig = RISK_CONFIG[riskLevel];
    
    const customIcon = L.divIcon({
        className: 'risk-marker',
        html: `
            <div style="
                background: ${riskConfig.color};
                border: 3px solid white;
                border-radius: 50%;
                width: ${riskConfig.size}px;
                height: ${riskConfig.size}px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: 700;
                font-size: ${riskConfig.fontSize}px;
                box-shadow: 0 4px 12px ${riskConfig.shadow};
                ${riskConfig.animation}
            ">
                ${riskConfig.icon}
            </div>
        `,
        iconSize: [riskConfig.size, riskConfig.size],
        iconAnchor: [riskConfig.size/2, riskConfig.size/2]
    });
    
    return L.marker([location.lat, location.lon], { icon: customIcon });
}
```

#### 2.2 필터링 기능
```javascript
function applyFilters() {
    const selectedRiskLevels = getSelectedRiskLevels();
    const filteredLocations = locations.filter(loc => {
        const riskLevel = loc.risk_assessment?.risk_level || 'unknown';
        return selectedRiskLevels.includes(riskLevel);
    });
    
    // 기존 마커 제거
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];
    
    // 필터링된 마커 추가
    filteredLocations.forEach((loc, index) => {
        const marker = createRiskMarker(loc, index);
        marker.addTo(map);
        markers.push(marker);
    });
}
```

#### 2.3 히트맵 레이어
```javascript
// Leaflet.heat 플러그인 사용
const heatData = locations.map(loc => {
    const riskScore = loc.risk_assessment?.risk_score || 0;
    return [loc.lat, loc.lon, riskScore];
});

const heatLayer = L.heatLayer(heatData, {
    radius: 25,
    blur: 15,
    maxZoom: 17,
    gradient: {
        0.0: 'green',
        0.5: 'yellow',
        1.0: 'red'
    }
});

// 토글 버튼으로 히트맵 표시/숨김
```

---

## 📈 구현 우선순위

### Phase 1 (필수 기능)
1. ✅ 위험도 기반 마커 색상 변경
2. ✅ 위험도 정보를 팝업에 표시
3. ✅ 위험도별 통계 카드 추가

### Phase 2 (핵심 기능)
4. ⭐ 위험도 등급 필터링
5. ⭐ 마커 클러스터링
6. ⭐ 위험 지역 경고 배너

### Phase 3 (고급 기능)
7. 🔮 히트맵 기능
8. 🔮 시간대별 통계
9. 🔮 지역별 위험도 분포 분석

---

## 🎯 예상 효과

### 사용자 경험 개선
- **시각적 직관성**: 위험도에 따른 색상으로 한눈에 파악 가능
- **정보 접근성**: 필터링으로 원하는 정보만 빠르게 확인
- **안전성 향상**: 위험 지역에 대한 명확한 경고

### 데이터 활용성 증대
- **연구 지원**: 지역별 위험 곤충 분포 패턴 분석 가능
- **정책 수립**: 위험도 높은 지역에 대한 대응 방안 수립 지원
- **시민 참여**: 시각적 정보로 시민 관심도 및 참여율 증가

---

## 🔍 추가 고려사항

### 1. 성능 최적화
- 마커가 많을 경우 (100개 이상) 클러스터링 필수
- 히트맵은 선택적 로드
- 지도 확대/축소 시 동적 마커 로딩

### 2. 접근성
- 색상만으로 구분하지 않고 아이콘과 텍스트 병행
- 키보드 네비게이션 지원
- 스크린 리더 호환

### 3. 데이터 보안
- 개인정보 보호 (위치 정보 익명화 옵션)
- 민감한 위치 정보 필터링

### 4. 확장성
- 다른 생물종 (식물, 동물)으로 확장 가능한 구조
- 다양한 위험도 평가 기준 적용 가능

---

## 📝 참고 자료

- 현재 위험도 평가 시스템: `utils/risk_assessor.py`
- 분류 정보 저장 시스템: `utils/classification_storage.py`
- 지도 라이브러리: Leaflet.js
- 히트맵 플러그인: Leaflet.heat
- 클러스터링 플러그인: Leaflet.markercluster

---

## ✅ 체크리스트

- [ ] 위험도 정보를 분류 저장소에 포함
- [ ] 지도 페이지에 위험도 정보 전달
- [ ] 위험도별 마커 스타일 구현
- [ ] 필터링 UI 구현
- [ ] 통계 대시보드 확장
- [ ] 히트맵 기능 구현
- [ ] 반응형 디자인 적용
- [ ] 성능 테스트 및 최적화

---

**작성일**: 2024년  
**버전**: 1.0  
**작성자**: NEST 프로젝트 팀

