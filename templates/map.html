<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>NEST ê³¤ì¶©ìƒíƒœì§€ë„ - ìƒíƒœì§€ë„ ë³´ê¸°</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #3182F6;
      --primary-hover: #2563EB;
      --primary-light: #E8F0FE;
      --primary-lighter: #DBEAFE;
      --bg-primary: #FFFFFF;
      --bg-secondary: #F5F7FA;
      --bg-tertiary: #FAFBFC;
      --text-primary: #1F2937;
      --text-secondary: #6B7280;
      --text-tertiary: #9CA3AF;
      --border-color: #E5E7EB;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
      --shadow-primary: 0 4px 12px rgba(49, 130, 246, 0.2);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", sans-serif;
      background: #FFFFFF;
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      padding-bottom: 100px; /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ê³µê°„ */
    }

    /* ìƒë‹¨ í—¤ë” - ìœ„ì¹˜ ì„ íƒ */
    .top-header {
      background: linear-gradient(135deg, #3182F6 0%, #4285F4 100%);
      padding: 12px 16px;
      color: white;
      display: flex;
      align-items: center;
      gap: 8px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .app-title {
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
    }

    .app-title-text {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .header {
      background: var(--bg-primary);
      padding: 20px 16px;
      margin-bottom: 16px;
    }

    .header .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header h1 {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 6px;
      letter-spacing: -0.5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary-light);
      color: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .info-icon:hover {
      background: var(--primary-color);
      color: white;
      transform: scale(1.1);
    }

    .header .subtitle {
      font-size: 13px;
      color: var(--text-secondary);
      letter-spacing: -0.2px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 16px 100px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--bg-primary);
      border: 1.5px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 16px;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      transform: scaleX(0);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-md), var(--shadow-primary);
      border-color: var(--primary-color);
    }

    .stat-card:hover::before {
      transform: scaleX(1);
    }

    .stat-card .label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
      letter-spacing: -0.1px;
    }

    .stat-card .value {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
    }

    .map-container {
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-md), 0 0 0 1px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      margin-bottom: 32px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid var(--border-color);
    }

    .map-container:hover {
      box-shadow: var(--shadow-lg), 0 0 0 1px rgba(49, 130, 246, 0.1);
      transform: translateY(-2px);
    }

    #map {
      width: 100%;
      height: 400px;
      position: relative;
    }

    /* í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ */
    .current-location-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      background: white;
      border: 2px solid var(--primary-color);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 24px;
    }

    .current-location-btn:hover {
      background: var(--primary-color);
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(49, 130, 246, 0.3);
    }

    .current-location-btn:active {
      transform: scale(0.95);
    }

    .current-location-btn.loading {
      opacity: 0.6;
      cursor: wait;
    }

    /* í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ìŠ¤íƒ€ì¼ (ì‚¬ëŒ ì•„ì´ì½˜) */
    .current-location-marker {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary-color);
      border: 3px solid white;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(49, 130, 246, 0.4), 0 0 0 2px rgba(49, 130, 246, 0.2);
      font-size: 20px;
      line-height: 1;
    }

    .info-panel {
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-md), 0 0 0 1px rgba(0, 0, 0, 0.05);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid var(--border-color);
      margin-bottom: 20px;
    }

    .info-panel:hover {
      box-shadow: var(--shadow-lg), 0 0 0 1px rgba(49, 130, 246, 0.1);
    }

    .info-panel h2 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text-primary);
      letter-spacing: -0.3px;
    }

    .image-list {
      max-height: 600px;
      overflow-y: auto;
      padding-right: 8px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .image-list::-webkit-scrollbar {
      width: 6px;
    }

    .image-list::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 3px;
    }

    .image-list::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }

    .image-list::-webkit-scrollbar-thumb:hover {
      background: var(--text-tertiary);
    }

    .image-item {
      display: flex;
      flex-direction: column;
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
      position: relative;
    }

    .image-item:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-color);
    }

    .image-item.active {
      border: 2px solid var(--primary-color);
      box-shadow: var(--shadow-primary);
    }

    .image-item-header {
      position: relative;
      width: 100%;
      height: 180px;
      overflow: hidden;
      background: var(--bg-secondary);
    }

    .image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .image-item:hover img {
      transform: scale(1.1);
    }

    .image-item-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
      padding: 12px;
      color: white;
    }

    .image-item-content {
      padding: 16px;
    }

    .weather-info {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
      padding: 6px 10px;
      background: var(--bg-secondary);
      border-radius: 8px;
      font-size: 12px;
    }

    .weather-icon {
      font-size: 16px;
    }

    .weather-temp {
      font-weight: 600;
      color: var(--text-primary);
    }

    .weather-desc {
      color: var(--text-secondary);
      font-size: 11px;
    }

    /* í•„í„° ì²´í¬ë°•ìŠ¤ í˜¸ë²„ íš¨ê³¼ */
    .filter-checkbox:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .filter-checkbox input[type="checkbox"]:checked + span {
      font-weight: 600;
    }

    /* circleMarker ê·¸ë¦¼ì íš¨ê³¼ */
    .risk-marker path {
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    /* í•„í„° íŒ¨ë„ ìŠ¤íƒ€ì¼ ê°œì„  */
    .filter-panel {
      position: sticky;
      top: 80px;
      z-index: 10;
    }

    @media (max-width: 768px) {
      .filter-panel {
        position: relative;
        top: 0;
      }
    }

    .image-info {
      flex: 1;
    }

    .image-info {
      flex: 1;
      min-width: 0;
    }

    .image-info .filename {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      letter-spacing: -0.2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .image-info .location {
      font-size: 12px;
      color: var(--text-secondary);
      letter-spacing: -0.1px;
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
    }

    .image-info .location-icon {
      font-size: 14px;
    }

    .image-species {
      font-size: 13px;
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 4px;
    }

    .no-location {
      text-align: center;
      padding: 64px 32px;
      color: var(--text-tertiary);
    }

    .no-location-icon {
      font-size: 64px;
      margin-bottom: 24px;
      opacity: 0.6;
    }

    .no-location h2 {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 12px;
      letter-spacing: -0.3px;
    }

    .no-location p {
      font-size: 15px;
      color: var(--text-tertiary);
      letter-spacing: -0.2px;
    }

    /* Leaflet ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í„°ë§ˆì´ì§• - í† ìŠ¤ ìŠ¤íƒ€ì¼ */
    .custom-marker {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      border: 3px solid white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 15px;
      box-shadow: 0 4px 12px rgba(49, 130, 246, 0.4), 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .custom-marker:hover {
      transform: scale(1.15);
      box-shadow: 0 6px 20px rgba(49, 130, 246, 0.5), 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    /* ì •ë³´ íŒì—… ìŠ¤íƒ€ì¼ - í† ìŠ¤ ìŠ¤íƒ€ì¼ */
    .leaflet-popup-content-wrapper {
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: 0;
      overflow: hidden;
    }

    .leaflet-popup-content {
      margin: 0;
    }

    .popup-content {
      text-align: center;
      padding: 20px;
    }

    .popup-content h3 {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 12px 0;
      color: var(--text-primary);
      letter-spacing: -0.3px;
    }

    .popup-content img {
      width: 220px;
      height: auto;
      border-radius: var(--radius-md);
      margin-bottom: 12px;
      box-shadow: var(--shadow-sm);
    }

    .popup-content p {
      font-size: 13px;
      color: var(--text-secondary);
      margin: 6px 0;
      letter-spacing: -0.1px;
    }

    .popup-content a {
      display: inline-block;
      margin-top: 12px;
      padding: 10px 20px;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      color: white;
      text-decoration: none;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(49, 130, 246, 0.3);
      letter-spacing: -0.1px;
    }

    .popup-content a:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(49, 130, 246, 0.4);
    }

    /* ìœ„í—˜ë„ ê¸°ì¤€ ëª¨ë‹¬ */
    .risk-criteria-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow-y: auto;
    }

    .risk-criteria-modal.show {
      display: flex;
    }

    /* ìœ„ì¹˜ ê¶Œí•œ ìš”ì²­ ëª¨ë‹¬ */
    .location-permission-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10001;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .location-permission-modal.show {
      display: flex;
    }

    /* ìœ„ì¹˜ ì˜¤ë¥˜ ëª¨ë‹¬ */
    .location-error-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10002;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .location-error-modal.show {
      display: flex;
    }

    .location-error-content {
      background: white;
      border-radius: 20px;
      width: 100%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      animation: slideInUp 0.3s ease-out;
    }

    .location-error-header {
      padding: 24px 24px 16px;
      text-align: center;
      border-bottom: 1px solid var(--border-color);
    }

    .location-error-header h2 {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 8px 0;
    }

    .location-error-icon {
      font-size: 48px;
      margin-bottom: 8px;
    }

    .location-error-body {
      padding: 24px;
      text-align: left;
    }

    .location-error-body p {
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin: 0 0 16px 0;
    }

    .location-error-body ul {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.8;
      margin: 0 0 24px 0;
      padding-left: 20px;
    }

    .location-error-body li {
      margin-bottom: 8px;
    }

    .location-error-button {
      width: 100%;
      padding: 14px 24px;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(49, 130, 246, 0.3);
    }

    .location-error-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(49, 130, 246, 0.4);
    }

    .location-permission-content {
      background: white;
      border-radius: 20px;
      width: 100%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      animation: slideInUp 0.3s ease-out;
    }

    .location-permission-header {
      padding: 24px 24px 16px;
      text-align: center;
    }

    .location-permission-header h2 {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 8px 0;
    }

    .location-permission-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .location-permission-body {
      padding: 0 24px 24px;
      text-align: center;
    }

    .location-permission-body p {
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin: 0 0 24px 0;
    }

    .location-permission-buttons {
      display: flex;
      gap: 12px;
    }

    .location-permission-btn {
      flex: 1;
      padding: 14px 24px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .location-permission-btn.primary {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(49, 130, 246, 0.3);
    }

    .location-permission-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(49, 130, 246, 0.4);
    }

    .location-permission-btn.secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .location-permission-btn.secondary:hover {
      background: var(--bg-tertiary);
    }

    .location-option-btn {
      width: 100%;
      padding: 16px;
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
    }

    .location-option-btn:hover {
      border-color: var(--primary-color);
      background: var(--primary-lighter);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .location-option-btn:active {
      transform: translateY(0);
    }

    .location-option-btn {
      width: 100%;
      padding: 16px;
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
    }

    .location-option-btn:hover {
      border-color: var(--primary-color);
      background: var(--primary-lighter);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .location-option-btn:active {
      transform: translateY(0);
    }

    .risk-criteria-content {
      background: white;
      border-radius: 20px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      animation: slideInUp 0.3s ease-out;
    }

    @keyframes slideInUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .risk-criteria-header {
      padding: 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      background: white;
      border-radius: 20px 20px 0 0;
      z-index: 1;
    }

    .risk-criteria-header h2 {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .risk-criteria-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .risk-criteria-close:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .risk-criteria-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .risk-criteria-item {
      margin-bottom: 24px;
      padding: 20px;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      border-left: 4px solid;
    }

    .risk-criteria-item:last-child {
      margin-bottom: 0;
    }

    .risk-criteria-item.high-risk {
      border-left-color: #dc3545;
      background: #fff5f5;
    }

    .risk-criteria-item.medium-risk {
      border-left-color: #fd7e14;
      background: #fff8f0;
    }

    .risk-criteria-item.pet-risk {
      border-left-color: #ffc107;
      background: #fffef5;
    }

    .risk-criteria-item.general {
      border-left-color: #6c757d;
      background: #f8f9fa;
    }

    .risk-criteria-item.protected {
      border-left-color: #28a745;
      background: #f0f9f4;
    }

    .risk-criteria-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .risk-criteria-title .risk-icon {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .risk-criteria-item.high-risk .risk-icon {
      background: #dc3545;
    }

    .risk-criteria-item.medium-risk .risk-icon {
      background: #fd7e14;
    }

    .risk-criteria-item.pet-risk .risk-icon {
      background: #ffc107;
    }

    .risk-criteria-item.general .risk-icon {
      background: #6c757d;
    }

    .risk-criteria-item.protected .risk-icon {
      background: #28a745;
    }

    .risk-criteria-description {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .risk-criteria-example {
      font-size: 13px;
      color: var(--text-tertiary);
      font-style: italic;
      padding-left: 16px;
      border-left: 2px solid var(--border-color);
    }

    /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #E5E7EB;
      padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
      z-index: 9999;
      display: flex;
      justify-content: space-around;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.06);
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px 24px;
      color: #6B7280;
      font-size: 11px;
      transition: color 0.2s ease;
      text-decoration: none;
    }

    .nav-item.active {
      color: #3182F6;
    }

    .nav-icon {
      font-size: 24px;
      background: white;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .nav-item:hover .nav-icon,
    .nav-item.active .nav-icon {
      background: white;
    }

    /* ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 768px) {
      .container {
        padding: 0 16px 24px;
      }

      .header {
        padding: 16px;
      }

      .header h1 {
        font-size: 18px;
      }

      .header .subtitle {
        font-size: 12px;
      }

      .stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .stat-card {
        padding: 12px;
      }

      .stat-card .label {
        font-size: 12px;
      }

      .stat-card .value {
        font-size: 20px;
      }

      .risk-stats {
        grid-template-columns: repeat(6, 1fr) !important;
        gap: 4px !important;
      }

      .risk-stat-card {
        padding: 8px !important;
      }

      .risk-stat-card .label {
        font-size: 10px !important;
        margin-bottom: 2px !important;
      }

      .risk-stat-card .value {
        font-size: 16px !important;
      }

      .info-panel {
        padding: 16px;
      }

      .info-panel h2 {
        font-size: 14px;
      }

      #map {
        height: 350px;
      }

      .image-list {
        grid-template-columns: 1fr;
      }

      .image-item-header {
        height: 200px;
      }

      .image-item {
        margin-bottom: 0;
      }

      .filter-panel {
        padding: 16px !important;
        margin-top: 16px !important;
        margin-bottom: 16px !important;
      }

      .filter-panel > div:first-child {
        font-size: 14px !important;
        margin-bottom: 12px !important;
      }

      .filter-checkbox {
        padding: 8px 12px !important;
        font-size: 12px !important;
      }

      .filter-checkbox span {
        font-size: 11px !important;
      }
    }

    /* í•„í„° ì˜µì…˜ ìŠ¤íƒ€ì¼ */
    .filter-option:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .filter-option input:checked + div + div {
      font-weight: 700;
    }

    .filter-option:has(input:checked) {
      border-color: var(--primary-color) !important;
      box-shadow: 0 0 0 1px var(--primary-color);
    }

    /* ë°ìŠ¤í¬í†± ëŒ€ì‘ */
    @media (min-width: 768px) {
      body {
        max-width: 768px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <!-- ìƒë‹¨ í—¤ë” -->
  <div class="top-header">
    <div class="app-title">
      <span class="app-title-text">NEST</span>
    </div>
  </div>

  <div class="header">
    <div class="container">
      <h1>
        NEST ê³¤ì¶©ìƒíƒœì§€ë„
        <span class="info-icon" onclick="showRiskCriteria()" title="ìœ„í—˜ë„ ê¸°ì¤€ ë³´ê¸°">?</span>
      </h1>
      <p class="subtitle">ì—…ë¡œë“œëœ ê³¤ì¶© ì‚¬ì§„ì˜ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ë„ì— í‘œì‹œí•©ë‹ˆë‹¤</p>
    </div>
  </div>

  <!-- ìœ„ì¹˜ ì˜µì…˜ ì„ íƒ ëª¨ë‹¬ -->
  <div id="locationOptionsModal" class="location-permission-modal" onclick="closeLocationOptionsModal()">
    <div class="location-permission-content" onclick="event.stopPropagation()">
      <div class="location-permission-header">
        <div class="location-permission-icon">ğŸ“</div>
        <h2>ë‚´ ìœ„ì¹˜ ì„¤ì •</h2>
      </div>
      <div class="location-permission-body">
        <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px;">
          ìœ„ì¹˜ë¥¼ ì„¤ì •í•˜ëŠ” ë°©ë²•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
        </p>
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <button class="location-option-btn" onclick="requestLocationPermission()">
            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ“¡</div>
            <div style="font-weight: 600; margin-bottom: 4px;">ì •í™•í•œ ìœ„ì¹˜ ì‚¬ìš©</div>
            <div style="font-size: 12px; color: var(--text-secondary);">GPSë¥¼ ì‚¬ìš©í•˜ì—¬ ì •í™•í•œ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤</div>
          </button>
          <button class="location-option-btn" onclick="getLocationByIP()">
            <div style="font-size: 24px; margin-bottom: 8px;">ğŸŒ</div>
            <div style="font-weight: 600; margin-bottom: 4px;">IP ê¸°ë°˜ ìœ„ì¹˜ (ê¶Œí•œ ë¶ˆí•„ìš”)</div>
            <div style="font-size: 12px; color: var(--text-secondary);">ì¸í„°ë„· ì—°ê²° ìœ„ì¹˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ëŒ€ëµì ì¸ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤</div>
          </button>
          <button class="location-option-btn" onclick="enableMapClickLocation()">
            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ‘†</div>
            <div style="font-weight: 600; margin-bottom: 4px;">ì§€ë„ì—ì„œ ì§ì ‘ ì„ íƒ</div>
            <div style="font-size: 12px; color: var(--text-secondary);">ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ì›í•˜ëŠ” ìœ„ì¹˜ë¥¼ ì„ íƒí•©ë‹ˆë‹¤</div>
          </button>
        </div>
        <div style="margin-top: 20px;">
          <button class="location-permission-btn secondary" onclick="closeLocationOptionsModal()" style="width: 100%;">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ìœ„ì¹˜ ê¶Œí•œ ìš”ì²­ ëª¨ë‹¬ -->
  <div id="locationPermissionModal" class="location-permission-modal" onclick="closeLocationPermissionModal()">
    <div class="location-permission-content" onclick="event.stopPropagation()">
      <div class="location-permission-header">
        <div class="location-permission-icon">ğŸ“</div>
        <h2>ìœ„ì¹˜ ì •ë³´ ì‚¬ìš©</h2>
      </div>
      <div class="location-permission-body">
        <p>
          í˜„ì¬ ìœ„ì¹˜ë¥¼ ì§€ë„ì— í‘œì‹œí•˜ê¸° ìœ„í•´<br>
          ìœ„ì¹˜ ì •ë³´ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.
        </p>
        <p style="font-size: 13px; color: var(--text-tertiary); margin-top: 8px;">
          ìœ„ì¹˜ ì •ë³´ëŠ” ì§€ë„ì— í‘œì‹œí•˜ëŠ” ìš©ë„ë¡œë§Œ ì‚¬ìš©ë˜ë©°<br>
          ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </p>
        <div class="location-permission-buttons">
          <button class="location-permission-btn secondary" onclick="closeLocationPermissionModal()">ì·¨ì†Œ</button>
          <button class="location-permission-btn primary" onclick="requestLocationPermission()">í—ˆìš©</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ìœ„ì¹˜ ì˜¤ë¥˜ ëª¨ë‹¬ -->
  <div id="locationErrorModal" class="location-error-modal" onclick="closeLocationErrorModal()">
    <div class="location-error-content" onclick="event.stopPropagation()">
      <div class="location-error-header">
        <div class="location-error-icon">âš ï¸</div>
        <h2 id="locationErrorTitle">ìœ„ì¹˜ ì •ë³´ ì˜¤ë¥˜</h2>
      </div>
      <div class="location-error-body">
        <p id="locationErrorMessage">ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        <ul id="locationErrorInstructions" style="display: none;">
        </ul>
        <button class="location-error-button" onclick="closeLocationErrorModal()">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- ìœ„í—˜ë„ ê¸°ì¤€ ëª¨ë‹¬ -->
  <div id="riskCriteriaModal" class="risk-criteria-modal" onclick="closeRiskCriteriaOnBackdrop(event)">
    <div class="risk-criteria-content" onclick="event.stopPropagation()">
      <div class="risk-criteria-header">
        <h2>ìœ„í—˜ë„ ê¸°ì¤€</h2>
        <button class="risk-criteria-close" onclick="closeRiskCriteria()">Ã—</button>
      </div>
      <div class="risk-criteria-body">
        <div class="risk-criteria-item high-risk">
          <div class="risk-criteria-title">
            <span class="risk-icon"></span>
            <span>ì¸ì²´ ê³ ìœ„í—˜(ê³µê²©ì„±Â·ë…ì„±)</span>
          </div>
          <div class="risk-criteria-description">
            ì‚¬ëŒì„ ì ê·¹ì ìœ¼ë¡œ ê³µê²©í•˜ê±°ë‚˜, ì—¬ëŸ¬ ë²ˆ ì˜ì´ê±°ë‚˜ ë¬¼ë¦¬ë©´ ìƒëª…ì— ìœ„í˜‘ì´ ë  ìˆ˜ ìˆëŠ” ì¢…ì…ë‹ˆë‹¤.
          </div>
          <div class="risk-criteria-example">
            ì˜ˆì‹œ: ë§ë²Œë¥˜, ì¼ë¶€ ë…ê°œë¯¸ë¥˜ ë“±
          </div>
        </div>

        <div class="risk-criteria-item medium-risk">
          <div class="risk-criteria-title">
            <span class="risk-icon"></span>
            <span>ì¸ì²´ ì¤‘ìœ„í—˜(ë…ì„±Â·í”¼ë¶€ì—¼Â·ì§ˆë³‘ ë§¤ê°œ)</span>
          </div>
          <div class="risk-criteria-description">
            ìŠ¤ìŠ¤ë¡œ ê³µê²©ì„±ì€ í¬ì§€ ì•Šì§€ë§Œ, ë…ì„± ë¬¼ì§ˆì´ë‚˜ ë³‘ì›ì²´ë¥¼ í†µí•´ í”¼ë¶€ì—¼, ì•Œë ˆë¥´ê¸°, ê°ì—¼ë³‘ ë“±ì„ ì¼ìœ¼í‚¬ ìˆ˜ ìˆëŠ” ì¢…ì…ë‹ˆë‹¤.
          </div>
          <div class="risk-criteria-example">
            ì˜ˆì‹œ: í™”ìƒë²Œë ˆ(ì²­ë”±ì§€ê°œë¯¸ë°˜ë‚ ê°œ), ì¼ë¶€ ë…ë‚˜ë°© ìœ ì¶©, ì§ˆë³‘ ë§¤ê°œ ëª¨ê¸° ë“±
          </div>
        </div>

        <div class="risk-criteria-item pet-risk">
          <div class="risk-criteria-title">
            <span class="risk-icon"></span>
            <span>ë°˜ë ¤ë™ë¬¼ ìœ„í—˜</span>
          </div>
          <div class="risk-criteria-description">
            ì‚¬ëŒë³´ë‹¤ë„ ê°•ì•„ì§€Â·ê³ ì–‘ì´ ë“± ë°˜ë ¤ë™ë¬¼ì—ê²Œ ë” í° ê±´ê°• í”¼í•´ë¥¼ ì¤„ ìˆ˜ ìˆëŠ” ì¢…ì…ë‹ˆë‹¤.
          </div>
          <div class="risk-criteria-example">
            ì˜ˆì‹œ: ì‹¬ì¥ì‚¬ìƒì¶©ì„ ì˜®ê¸°ëŠ” ëª¨ê¸°, ë²¼ë£©, ì¼ë¶€ ì§„ë“œê¸° ë“±
          </div>
        </div>

        <div class="risk-criteria-item general">
          <div class="risk-criteria-title">
            <span class="risk-icon"></span>
            <span>ì¼ë°˜Â·ë¶ˆì¾Œ ê³¤ì¶©</span>
          </div>
          <div class="risk-criteria-description">
            ì§ì ‘ì ì¸ ë…ì„±ì´ë‚˜ ì§ˆë³‘ ìœ„í—˜ì€ í¬ì§€ ì•Šì§€ë§Œ, ìœ„ìƒ ë¬¸ì œë‚˜ í˜ì˜¤ê°, ëŒ€ëŸ‰ ë°œìƒìœ¼ë¡œ ìƒí™œ ë¶ˆí¸ì„ ì¤„ ìˆ˜ ìˆëŠ” ì¢…ì…ë‹ˆë‹¤.
          </div>
          <div class="risk-criteria-example">
            ì˜ˆì‹œ: ë°”í€´ë²Œë ˆ, ì§‘íŒŒë¦¬, ë‚˜ë°©íŒŒë¦¬, ê¼½ë“±ì´ ë“±
          </div>
        </div>

        <div class="risk-criteria-item protected">
          <div class="risk-criteria-title">
            <span class="risk-icon"></span>
            <span>ë³´í˜¸ê°€ í•„ìš”í•œ ì¢…</span>
          </div>
          <div class="risk-criteria-description">
            ì²œì—°ê¸°ë…ë¬¼, ë©¸ì¢…ìœ„ê¸°ì¢…, ë²•ì •ë³´í˜¸ì¢… ë“±ìœ¼ë¡œ ì§€ì •ë˜ì–´ ì‚¬ëŒì—ê²Œ í•´ë¥¼ ì£¼ì§€ ì•Šê³ , ì˜¤íˆë ¤ ìƒíƒœê³„ ë³´ì „ì— ì¤‘ìš”í•œ ì¢…ì…ë‹ˆë‹¤.
          </div>
          <div class="risk-criteria-example" style="font-weight: 600; color: var(--text-primary);">
            í¬íšÂ·í›¼ì†ì´ ë²•ì ìœ¼ë¡œ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    {% if locations %}
      <!-- ì§€ë„ (ë§¨ ìœ„) -->
      <div class="map-container" style="margin-bottom: 20px; position: relative;">
        <div id="map"></div>
        <button class="current-location-btn" onclick="showLocationOptions()" title="ë‚´ ìœ„ì¹˜ ì„¤ì •">
          ğŸ“
        </button>
      </div>

      <!-- í•„í„° íŒ¨ë„ -->
      <div class="info-panel" style="margin-top: 20px; margin-bottom: 20px; padding: 20px;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
          <h2 style="margin: 0; font-size: 16px; font-weight: 600;">ğŸ” ìœ„í—˜ë„ í•„í„°</h2>
          <button onclick="toggleFilterModal()" style="background: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
            í•„í„° ì„ íƒ
          </button>
        </div>
        <div id="selectedFilters" style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 32px;">
          <span style="font-size: 13px; color: var(--text-secondary);">ëª¨ë“  ìœ„í—˜ë„ í‘œì‹œ ì¤‘</span>
        </div>
      </div>

      <!-- í•„í„° ëª¨ë‹¬ -->
      <div id="filterModal" class="location-permission-modal" onclick="closeFilterModal()">
        <div class="location-permission-content" onclick="event.stopPropagation()" style="max-width: 500px;">
          <div class="location-permission-header">
            <h2>ìœ„í—˜ë„ í•„í„° ì„ íƒ</h2>
          </div>
          <div class="location-permission-body" style="text-align: left;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
              <label class="filter-option" style="display: flex; flex-direction: column; align-items: center; padding: 16px; background: #FEE2E2; border: 2px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.2s ease;">
                <input type="checkbox" value="critical" checked style="display: none;">
                <div style="font-size: 24px; margin-bottom: 8px;">ğŸ”´</div>
                <div style="font-size: 12px; font-weight: 600; text-align: center; color: #991B1B;">ì¸ì²´ ê³ ìœ„í—˜</div>
              </label>
              <label class="filter-option" style="display: flex; flex-direction: column; align-items: center; padding: 16px; background: #FFEDD5; border: 2px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.2s ease;">
                <input type="checkbox" value="danger" checked style="display: none;">
                <div style="font-size: 24px; margin-bottom: 8px;">ğŸŸ </div>
                <div style="font-size: 12px; font-weight: 600; text-align: center; color: #9A3412;">ì¸ì²´ ì¤‘ìœ„í—˜</div>
              </label>
              <label class="filter-option" style="display: flex; flex-direction: column; align-items: center; padding: 16px; background: #FEF3C7; border: 2px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.2s ease;">
                <input type="checkbox" value="caution" checked style="display: none;">
                <div style="font-size: 24px; margin-bottom: 8px;">ğŸŸ¡</div>
                <div style="font-size: 12px; font-weight: 600; text-align: center; color: #854D0E;">ë°˜ë ¤ë™ë¬¼ ìœ„í—˜</div>
              </label>
              <label class="filter-option" style="display: flex; flex-direction: column; align-items: center; padding: 16px; background: #D1FAE5; border: 2px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.2s ease;">
                <input type="checkbox" value="safe" checked style="display: none;">
                <div style="font-size: 24px; margin-bottom: 8px;">ğŸŸ¢</div>
                <div style="font-size: 12px; font-weight: 600; text-align: center; color: #065F46;">ì¼ë°˜Â·ë¶ˆì¾Œ</div>
              </label>
              <label class="filter-option" style="display: flex; flex-direction: column; align-items: center; padding: 16px; background: #F3F4F6; border: 2px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.2s ease;">
                <input type="checkbox" value="unknown" checked style="display: none;">
                <div style="font-size: 24px; margin-bottom: 8px;">âšª</div>
                <div style="font-size: 12px; font-weight: 600; text-align: center; color: #4B5563;">ë³´í˜¸ í•„ìš”</div>
              </label>
              <label class="filter-option" style="display: flex; flex-direction: column; align-items: center; padding: 16px; background: #DBEAFE; border: 2px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.2s ease;">
                <input type="checkbox" value="unclassified" checked style="display: none;">
                <div style="font-size: 24px; margin-bottom: 8px;">ğŸ”µ</div>
                <div style="font-size: 12px; font-weight: 600; text-align: center; color: #1E3A8A;">ë¯¸ë¶„ë¥˜</div>
              </label>
            </div>
            <div style="display: flex; gap: 12px;">
              <button onclick="closeFilterModal()" class="location-permission-btn secondary" style="flex: 1;">ì·¨ì†Œ</button>
              <button onclick="applyFilters()" class="location-permission-btn primary" style="flex: 1;">í™•ì¸</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ìœ„í—˜ë„ í†µê³„ ì¹´ë“œ (3*2 ê·¸ë¦¬ë“œ) -->
      <div class="stats risk-stats" style="margin-top: 20px; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, 1fr); gap: 12px;">
      <div class="stat-card risk-stat-card" style="background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%); border-left: 3px solid #F44336; padding: 16px;">
        <div class="label" style="color: #991B1B; font-size: 12px; margin-bottom: 8px; line-height: 1.3; font-weight: 600;">ğŸ”´ ì¸ì²´ ê³ ìœ„í—˜</div>
        <div class="value" style="background: linear-gradient(135deg, #F44336 0%, #DC2626 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 24px;">{{ risk_stats.critical }}</div>
      </div>
      <div class="stat-card risk-stat-card" style="background: linear-gradient(135deg, #FFEDD5 0%, #FED7AA 100%); border-left: 3px solid #FF9800; padding: 16px;">
        <div class="label" style="color: #9A3412; font-size: 12px; margin-bottom: 8px; line-height: 1.3; font-weight: 600;">ğŸŸ  ì¸ì²´ ì¤‘ìœ„í—˜</div>
        <div class="value" style="background: linear-gradient(135deg, #FF9800 0%, #F97316 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 24px;">{{ risk_stats.danger }}</div>
      </div>
      <div class="stat-card risk-stat-card" style="background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border-left: 3px solid #FFC107; padding: 16px;">
        <div class="label" style="color: #854D0E; font-size: 12px; margin-bottom: 8px; line-height: 1.3; font-weight: 600;">ğŸŸ¡ ë°˜ë ¤ë™ë¬¼ ìœ„í—˜</div>
        <div class="value" style="background: linear-gradient(135deg, #FFC107 0%, #F59E0B 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 24px;">{{ risk_stats.caution }}</div>
      </div>
      <div class="stat-card risk-stat-card" style="background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%); border-left: 3px solid #4CAF50; padding: 16px;">
        <div class="label" style="color: #065F46; font-size: 12px; margin-bottom: 8px; line-height: 1.3; font-weight: 600;">ğŸŸ¢ ì¼ë°˜Â·ë¶ˆì¾Œ</div>
        <div class="value" style="background: linear-gradient(135deg, #4CAF50 0%, #22C55E 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 24px;">{{ risk_stats.safe }}</div>
      </div>
      <div class="stat-card risk-stat-card" style="background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%); border-left: 3px solid #9E9E9E; padding: 16px;">
        <div class="label" style="color: #4B5563; font-size: 12px; margin-bottom: 8px; line-height: 1.3; font-weight: 600;">âšª ë³´í˜¸ í•„ìš”</div>
        <div class="value" style="background: linear-gradient(135deg, #9E9E9E 0%, #6B7280 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 24px;">{{ risk_stats.unknown }}</div>
      </div>
      <div class="stat-card risk-stat-card" style="background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%); border-left: 3px solid #1E40AF; padding: 16px;">
        <div class="label" style="color: #1E3A8A; font-size: 12px; margin-bottom: 8px; line-height: 1.3; font-weight: 600;">ğŸ”µ ë¯¸ë¶„ë¥˜</div>
        <div class="value" style="background: linear-gradient(135deg, #1E40AF 0%, #1E3A8A 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 24px;">{{ risk_stats.unclassified }}</div>
      </div>
    </div>
    {% endif %}

    {% if locations %}
      <div class="info-panel">
        <h2>ìœ„ì¹˜ ì •ë³´ê°€ ìˆëŠ” ì´ë¯¸ì§€ ({{ locations|length }}ê°œ)</h2>
        <div class="image-list">
          {% for loc in locations %}
            {% set threat_level = loc.classification.threat_level if loc.classification and loc.classification.threat_level else '' %}
            {% if threat_level %}
              {% if 'ì¸ì²´ ê³ ìœ„í—˜' in threat_level or 'ê³µê²©ì„±Â·ë…ì„±' in threat_level %}
                {% set filter_level = 'critical' %}
              {% elif 'ì¸ì²´ ì¤‘ìœ„í—˜' in threat_level or 'ë…ì„±Â·í”¼ë¶€ì—¼' in threat_level or 'ì§ˆë³‘ ë§¤ê°œ' in threat_level %}
                {% set filter_level = 'danger' %}
              {% elif 'ë°˜ë ¤ë™ë¬¼ ìœ„í—˜' in threat_level %}
                {% set filter_level = 'caution' %}
              {% elif 'ì¼ë°˜Â·ë¶ˆì¾Œ' in threat_level or 'ë¶ˆì¾Œ ê³¤ì¶©' in threat_level or 'ì¼ë°˜Â·ë¶ˆì¾Œ ê³¤ì¶©' in threat_level %}
                {% set filter_level = 'safe' %}
              {% elif 'ë³´í˜¸' in threat_level or 'ì²œì—°ê¸°ë…ë¬¼' in threat_level %}
                {% set filter_level = 'unknown' %}
              {% else %}
                {% set filter_level = 'unclassified' %}
              {% endif %}
            {% elif loc.risk_assessment and loc.risk_assessment.threat_level %}
              {% set threat_level_from_assessment = loc.risk_assessment.threat_level %}
              {% if 'ì¸ì²´ ê³ ìœ„í—˜' in threat_level_from_assessment or 'ê³µê²©ì„±Â·ë…ì„±' in threat_level_from_assessment %}
                {% set filter_level = 'critical' %}
              {% elif 'ì¸ì²´ ì¤‘ìœ„í—˜' in threat_level_from_assessment or 'ë…ì„±Â·í”¼ë¶€ì—¼' in threat_level_from_assessment or 'ì§ˆë³‘ ë§¤ê°œ' in threat_level_from_assessment %}
                {% set filter_level = 'danger' %}
              {% elif 'ë°˜ë ¤ë™ë¬¼ ìœ„í—˜' in threat_level_from_assessment %}
                {% set filter_level = 'caution' %}
              {% elif 'ì¼ë°˜Â·ë¶ˆì¾Œ' in threat_level_from_assessment or 'ë¶ˆì¾Œ ê³¤ì¶©' in threat_level_from_assessment or 'ì¼ë°˜Â·ë¶ˆì¾Œ ê³¤ì¶©' in threat_level_from_assessment %}
                {% set filter_level = 'safe' %}
              {% elif 'ë³´í˜¸' in threat_level_from_assessment or 'ì²œì—°ê¸°ë…ë¬¼' in threat_level_from_assessment %}
                {% set filter_level = 'unknown' %}
              {% elif threat_level_from_assessment == 'ë¯¸ë¶„ë¥˜' %}
                {% set filter_level = 'unclassified' %}
              {% else %}
                {% set filter_level = 'unclassified' %}
              {% endif %}
            {% else %}
              {# threat_levelì´ ì—†ìœ¼ë©´ ë¯¸ë¶„ë¥˜ #}
              {% set filter_level = 'unclassified' %}
            {% endif %}
            <div class="image-item" id="image-item-{{ loop.index0 }}" onclick="showMarker({{ loop.index0 }})" data-risk-level="{{ filter_level }}">
              <div class="image-item-header">
                <img src="{{ url_for('uploaded_file', filename=loc.filename) }}" alt="{{ loc.filename }}" />
                {% if threat_level or (loc.risk_assessment and loc.risk_assessment.threat_level) %}
                <div class="image-item-overlay">
                  {% set display_threat_level = threat_level if threat_level else (loc.risk_assessment.threat_level if loc.risk_assessment and loc.risk_assessment.threat_level else '') %}
                  {% if display_threat_level %}
                    {% if 'ì¸ì²´ ê³ ìœ„í—˜' in display_threat_level or 'ê³µê²©ì„±Â·ë…ì„±' in display_threat_level %}
                      <span style="background: #dc3545; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">ğŸ”´ ì¸ì²´ ê³ ìœ„í—˜</span>
                    {% elif 'ì¸ì²´ ì¤‘ìœ„í—˜' in display_threat_level or 'ë…ì„±Â·í”¼ë¶€ì—¼' in display_threat_level or 'ì§ˆë³‘ ë§¤ê°œ' in display_threat_level %}
                      <span style="background: #fd7e14; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">ğŸŸ  ì¸ì²´ ì¤‘ìœ„í—˜</span>
                    {% elif 'ë°˜ë ¤ë™ë¬¼ ìœ„í—˜' in display_threat_level %}
                      <span style="background: #ffc107; color: #333; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">ğŸŸ¡ ë°˜ë ¤ë™ë¬¼ ìœ„í—˜</span>
                    {% elif 'ì¼ë°˜Â·ë¶ˆì¾Œ' in display_threat_level or 'ë¶ˆì¾Œ ê³¤ì¶©' in display_threat_level or 'ì¼ë°˜Â·ë¶ˆì¾Œ ê³¤ì¶©' in display_threat_level %}
                      <span style="background: #28a745; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">ğŸŸ¢ ì¼ë°˜Â·ë¶ˆì¾Œ</span>
                    {% elif 'ë³´í˜¸' in display_threat_level or 'ì²œì—°ê¸°ë…ë¬¼' in display_threat_level %}
                      <span style="background: #6c757d; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">âšª ë³´í˜¸ í•„ìš”</span>
                    {% elif display_threat_level == 'ë¯¸ë¶„ë¥˜' %}
                      <span style="background: #1E40AF; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">ğŸ”µ ë¯¸ë¶„ë¥˜</span>
                    {% else %}
                      <span style="background: #1E40AF; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">ğŸ”µ ë¯¸ë¶„ë¥˜</span>
                    {% endif %}
                  {% endif %}
                </div>
                {% endif %}
              </div>
              <div class="image-item-content">
                <div class="image-info">
                  {% if loc.classification and loc.classification.korean_name %}
                  <div class="image-species">{{ loc.classification.korean_name }}</div>
                  {% elif loc.classification and loc.classification.species %}
                  <div class="image-species">{{ loc.classification.species }}</div>
                  {% else %}
                  <div class="image-species" style="color: var(--text-secondary);">ë¯¸ë¶„ë¥˜</div>
                  {% endif %}
                  <div class="filename">
                    <span style="font-size: 12px; color: var(--text-secondary); margin-right: 4px;">ğŸ“…</span>
                    <span>{{ loc.datetime_taken if loc.datetime_taken else 'ì¼ì‹œ ì •ë³´ ì—†ìŒ' }}</span>
                  </div>
                  <div class="location">
                    <span class="location-icon">ğŸ“</span>
                    <span>{{ "%.4f"|format(loc.lat) }}, {{ "%.4f"|format(loc.lon) }}</span>
                  </div>
                  {% if loc.weather %}
                  <div class="weather-info">
                    <span class="weather-icon">{{ loc.weather.icon }}</span>
                    <span class="weather-temp">{{ loc.weather.temperature }}Â°C</span>
                    <span class="weather-desc">{{ loc.weather.weather_description }}</span>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <div class="info-panel">
        <div class="no-location">
          <div class="no-location-icon">ğŸ“</div>
          <h2>ìœ„ì¹˜ ì •ë³´ê°€ ìˆëŠ” ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</h2>
          <p>GPS ì •ë³´ê°€ í¬í•¨ëœ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ ì§€ë„ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
      </div>
    {% endif %}
  </div>

  {% if locations %}
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <script>
      // ìœ„í—˜ë„ ì´ë¦„ ë§¤í•‘ í•¨ìˆ˜
      function getRiskLevelName(riskLevel) {
        const riskNames = {
          'CRITICAL': 'ì¸ì²´ ê³ ìœ„í—˜',
          'critical': 'ì¸ì²´ ê³ ìœ„í—˜',
          'HIGH': 'ì¸ì²´ ì¤‘ìœ„í—˜',
          'danger': 'ì¸ì²´ ì¤‘ìœ„í—˜',
          'MEDIUM': 'ë°˜ë ¤ë™ë¬¼ ìœ„í—˜',
          'caution': 'ë°˜ë ¤ë™ë¬¼ ìœ„í—˜',
          'LOW': 'ì¼ë°˜Â·ë¶ˆì¾Œ',
          'safe': 'ì¼ë°˜Â·ë¶ˆì¾Œ',
          'unknown': 'ë³´í˜¸ í•„ìš”',
          'unclassified': 'ë¯¸ë¶„ë¥˜'
        };
        return riskNames[riskLevel] || 'ë³´í˜¸ í•„ìš”';
      }

      // ìœ„í—˜ë„ë³„ ë§ˆì»¤ ì„¤ì •
      const RISK_CONFIG = {
        'critical': {
          color: '#F44336', // ë¹¨ê°„ìƒ‰
          colorEnd: '#DC2626', // ë¹¨ê°„ìƒ‰
          size: 28, // í¬ê¸° ì¶•ì†Œ (48 -> 28)
          fontSize: '16px',
          shadow: 'rgba(220, 38, 38, 0.5)',
          className: 'risk-marker-critical'
        },
        'danger': {
          color: '#FF9800', // ì£¼í™©ìƒ‰
          colorEnd: '#F97316', // ì£¼í™©ìƒ‰
          size: 24, // í¬ê¸° ì¶•ì†Œ (40 -> 24)
          fontSize: '15px',
          shadow: 'rgba(249, 115, 22, 0.4)',
          className: 'risk-marker-danger'
        },
        'caution': {
          color: '#FFC107', // ë…¸ë€ìƒ‰
          colorEnd: '#F59E0B', // ë…¸ë€ìƒ‰
          size: 22, // í¬ê¸° ì¶•ì†Œ (36 -> 22)
          fontSize: '14px',
          shadow: 'rgba(245, 158, 11, 0.4)',
          className: 'risk-marker-caution'
        },
        'safe': {
          color: '#4CAF50', // ì´ˆë¡ìƒ‰
          colorEnd: '#22C55E', // ì´ˆë¡ìƒ‰
          size: 20, // í¬ê¸° ì¶•ì†Œ (32 -> 20)
          fontSize: '14px',
          shadow: 'rgba(34, 197, 94, 0.4)',
          className: 'risk-marker-safe'
        },
        'unknown': {
          color: '#9E9E9E', // íšŒìƒ‰
          colorEnd: '#6B7280', // íšŒìƒ‰
          size: 20, // í¬ê¸° ì¶•ì†Œ (32 -> 20)
          fontSize: '14px',
          shadow: 'rgba(107, 114, 128, 0.4)',
          className: 'risk-marker-unknown'
        },
        'unclassified': {
          color: '#1E40AF', // ë‚¨ìƒ‰
          colorEnd: '#1E3A8A', // ë‚¨ìƒ‰
          size: 20, // í¬ê¸° ì¶•ì†Œ (32 -> 20)
          fontSize: '14px',
          shadow: 'rgba(30, 58, 138, 0.4)',
          className: 'risk-marker-unclassified'
        }
      };

      // ìœ„ì¹˜ ë°ì´í„°ë¥¼ JavaScriptë¡œ ì „ë‹¬
      const locations = [
        {% for loc in locations %}
        {
          filename: "{{ loc.filename }}",
          lat: {{ loc.lat }},
          lon: {{ loc.lon }},
          imageUrl: "{{ url_for('uploaded_file', filename=loc.filename) }}",
          mapsUrl: "{{ loc.maps_url }}",
          riskAssessment: {{ loc.risk_assessment | tojson if loc.risk_assessment else 'null' }},
          classification: {{ loc.classification | tojson if loc.classification else 'null' }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ];

      let map;
      let markers = [];
      let allMarkers = [];
      let currentLocationMarker = null;

      // ì§€ë„ ì´ˆê¸°í™”
      function initMap() {
        if (locations.length === 0) {
          return;
        }

        // ì²« ë²ˆì§¸ ìœ„ì¹˜ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì§€ë„ ìƒì„±
        const firstLocation = locations[0];
        map = L.map('map').setView([firstLocation.lat, firstLocation.lon], 10);

        // OpenStreetMap íƒ€ì¼ ë ˆì´ì–´ ì¶”ê°€
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19
        }).addTo(map);

        // ì§€ë„ì— ê²©ì í‘œì‹œ (Canvas ë ˆì´ì–´ë¡œ ì§€ë„ì— ì§ì ‘ í†µí•©)
        function addGrid() {
          const GridLayer = L.GridLayer.extend({
            createTile: function(coords) {
              const tile = document.createElement('canvas');
              const ctx = tile.getContext('2d');
              const size = this.getTileSize();
              
              tile.width = size.x;
              tile.height = size.y;
              
              // íƒ€ì¼ì˜ ê²½ê³„ ì¢Œí‘œ ê³„ì‚°
              const nwPoint = coords.scaleBy(size);
              const sePoint = nwPoint.add(size);
              const nw = map.unproject(nwPoint, coords.z);
              const se = map.unproject(sePoint, coords.z);
              
              // ì¤Œ ë ˆë²¨ì— ë”°ë¼ ê²©ì ê°„ê²© ì¡°ì •
              const zoom = coords.z;
              let gridSize = 0.1;
              if (zoom >= 15) {
                gridSize = 0.01;
              } else if (zoom >= 12) {
                gridSize = 0.05;
              } else if (zoom >= 9) {
                gridSize = 0.1;
              } else {
                gridSize = 0.5;
              }
              
              // í°ìƒ‰ ê²©ìì„  ê·¸ë¦¬ê¸°
              ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
              ctx.lineWidth = 0.5;
              
              // ê²½ë„ì„  ê·¸ë¦¬ê¸°
              const startLon = Math.floor(nw.lng / gridSize) * gridSize;
              const endLon = Math.ceil(se.lng / gridSize) * gridSize;
              
              for (let lon = startLon; lon <= endLon; lon += gridSize) {
                const point = map.project([nw.lat, lon], coords.z);
                const relativeX = point.x - nwPoint.x;
                
                if (relativeX >= 0 && relativeX <= size.x) {
                  ctx.beginPath();
                  ctx.moveTo(relativeX, 0);
                  ctx.lineTo(relativeX, size.y);
                  ctx.stroke();
                }
              }
              
              // ìœ„ë„ì„  ê·¸ë¦¬ê¸°
              const startLat = Math.floor(se.lat / gridSize) * gridSize;
              const endLat = Math.ceil(nw.lat / gridSize) * gridSize;
              
              for (let lat = startLat; lat <= endLat; lat += gridSize) {
                const point = map.project([lat, nw.lng], coords.z);
                const relativeY = point.y - nwPoint.y;
                
                if (relativeY >= 0 && relativeY <= size.y) {
                  ctx.beginPath();
                  ctx.moveTo(0, relativeY);
                  ctx.lineTo(size.x, relativeY);
                  ctx.stroke();
                }
              }
              
              return tile;
            }
          });
          
          const gridLayer = new GridLayer({
            pane: 'overlayPane',
            opacity: 1.0,
            zIndex: 200
          });
          
          gridLayer.addTo(map);
        }
        
        addGrid();

        // ëª¨ë“  ìœ„ì¹˜ì— ë§ˆì»¤ ì¶”ê°€
        // circleMarkerëŠ” ì§€ë¦¬ì¢Œí‘œì— ì •í™•íˆ ê³ ì •ë˜ì–´ ìˆì–´ ì§€ë„ ì´ë™ ì‹œì—ë„ ìœ„ì¹˜ê°€ ì–´ê¸‹ë‚˜ì§€ ì•ŠìŒ
        locations.forEach((loc, index) => {
          const marker = createRiskMarker(loc, index);
          marker.addTo(map);
          
          allMarkers.push({
            marker: marker,
            index: index,
            location: loc
          });
        });

        // ì´ˆê¸°ì—ëŠ” ëª¨ë“  ë§ˆì»¤ í‘œì‹œ
        markers = [...allMarkers];

        // ëª¨ë“  ë§ˆì»¤ê°€ ë³´ì´ë„ë¡ ì§€ë„ ë²”ìœ„ ì¡°ì •
        if (locations.length > 1) {
          const bounds = L.latLngBounds(locations.map(loc => [loc.lat, loc.lon]));
          map.fitBounds(bounds, { padding: [60, 60] });
        }
      }

      // ì´ë¯¸ì§€ ì•„ì´í…œ í•˜ì´ë¼ì´íŠ¸
      function highlightImageItem(index) {
        // ëª¨ë“  ì•„ì´í…œì—ì„œ active í´ë˜ìŠ¤ ì œê±°
        document.querySelectorAll('.image-item').forEach(item => {
          item.classList.remove('active');
        });
        
        // ì„ íƒí•œ ì•„ì´í…œì— active í´ë˜ìŠ¤ ì¶”ê°€
        const item = document.getElementById(`image-item-${index}`);
        if (item) {
          item.classList.add('active');
          // ìŠ¤í¬ë¡¤í•˜ì—¬ ë³´ì´ë„ë¡
          item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }

      // ìœ„í—˜ë„ë³„ ë§ˆì»¤ ìƒì„± í•¨ìˆ˜
      function createRiskMarker(loc, index) {
        let riskLevel = 'unclassified'; // ê¸°ë³¸ê°’ì„ ë¯¸ë¶„ë¥˜ë¡œ ì„¤ì •
        
        // threat_level ìš°ì„  ì‚¬ìš©
        if (loc.classification && loc.classification.threat_level) {
          const threatLevel = loc.classification.threat_level;
          if (threatLevel.includes('ì¸ì²´ ê³ ìœ„í—˜') || threatLevel.includes('ê³µê²©ì„±Â·ë…ì„±')) {
            riskLevel = 'critical';
          } else if (threatLevel.includes('ì¸ì²´ ì¤‘ìœ„í—˜') || threatLevel.includes('ë…ì„±Â·í”¼ë¶€ì—¼') || threatLevel.includes('ì§ˆë³‘ ë§¤ê°œ')) {
            riskLevel = 'danger';
          } else if (threatLevel.includes('ë°˜ë ¤ë™ë¬¼ ìœ„í—˜')) {
            riskLevel = 'caution';
          } else if (threatLevel.includes('ì¼ë°˜Â·ë¶ˆì¾Œ') || threatLevel.includes('ë¶ˆì¾Œ ê³¤ì¶©') || threatLevel.includes('ì¼ë°˜Â·ë¶ˆì¾Œ ê³¤ì¶©')) {
            riskLevel = 'safe';
          } else if (threatLevel.includes('ë³´í˜¸') || threatLevel.includes('ì²œì—°ê¸°ë…ë¬¼')) {
            riskLevel = 'unknown';
          } else {
            // threat_levelì´ ìˆì§€ë§Œ ë§¤ì¹­ë˜ì§€ ì•ŠëŠ” ê²½ìš°ë„ ë¯¸ë¶„ë¥˜
            riskLevel = 'unclassified';
          }
        } else if (loc.riskAssessment && loc.riskAssessment.threat_level) {
          // risk_assessmentì˜ threat_level ì‚¬ìš©
          const threatLevel = loc.riskAssessment.threat_level;
          if (threatLevel.includes('ì¸ì²´ ê³ ìœ„í—˜') || threatLevel.includes('ê³µê²©ì„±Â·ë…ì„±')) {
            riskLevel = 'critical';
          } else if (threatLevel.includes('ì¸ì²´ ì¤‘ìœ„í—˜') || threatLevel.includes('ë…ì„±Â·í”¼ë¶€ì—¼') || threatLevel.includes('ì§ˆë³‘ ë§¤ê°œ')) {
            riskLevel = 'danger';
          } else if (threatLevel.includes('ë°˜ë ¤ë™ë¬¼ ìœ„í—˜')) {
            riskLevel = 'caution';
          } else if (threatLevel.includes('ì¼ë°˜Â·ë¶ˆì¾Œ') || threatLevel.includes('ë¶ˆì¾Œ ê³¤ì¶©') || threatLevel.includes('ì¼ë°˜Â·ë¶ˆì¾Œ ê³¤ì¶©')) {
            riskLevel = 'safe';
          } else if (threatLevel.includes('ë³´í˜¸') || threatLevel.includes('ì²œì—°ê¸°ë…ë¬¼')) {
            riskLevel = 'unknown';
          } else if (threatLevel === 'ë¯¸ë¶„ë¥˜') {
            riskLevel = 'unclassified';
          } else {
            riskLevel = 'unclassified';
          }
        } else {
          // threat_levelì´ ì—†ìœ¼ë©´ ë¯¸ë¶„ë¥˜
          riskLevel = 'unclassified';
        }
        
        // ìœ„í—˜ë„ê°€ ì´ë¯¸ íŒë‹¨ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ classification í™•ì¸
        // threat_levelì´ ìˆìœ¼ë©´ ì´ë¯¸ ìœ„í—˜ë„ê°€ íŒë‹¨ë˜ì—ˆìœ¼ë¯€ë¡œ ì´ ì¡°ê±´ì„ ë¬´ì‹œ
        if (riskLevel === 'unclassified' && 
            (!loc.classification || 
             (!loc.classification.species && !loc.classification.korean_name && !loc.classification.threat_level))) {
          riskLevel = 'unclassified';
        }
        
        const riskConfig = RISK_CONFIG[riskLevel] || RISK_CONFIG['unknown'];
        
        // L.circleMarker ì‚¬ìš© - ì§€ë¦¬ì¢Œí‘œì— ì •í™•íˆ ê³ ì •ë˜ì–´ ì§€ë„ ì´ë™ ì‹œì—ë„ ìœ„ì¹˜ê°€ ì–´ê¸‹ë‚˜ì§€ ì•ŠìŒ
        // divIcon ëŒ€ì‹  circleMarkerë¥¼ ì‚¬ìš©í•˜ë©´ anchor/CSS ì˜¤í”„ì…‹ ë¬¸ì œê°€ ì—†ì–´ ì•ˆì •ì 
        const radius = riskConfig.size / 2; // circleMarkerì˜ radiusëŠ” ë°˜ì§€ë¦„ì´ë¯€ë¡œ sizeì˜ ì ˆë°˜
        
        // ë§ˆì»¤ ìƒì„± (ì§€ë¦¬ì¢Œí‘œì— ì •í™•íˆ ê³ ì •)
        const marker = L.circleMarker([loc.lat, loc.lon], {
          radius: radius,
          fillColor: riskConfig.color,
          fillOpacity: 1,
          color: 'white',
          weight: 2,
          className: riskConfig.className || 'risk-marker',
          pane: 'markerPane'
        });

        // íŒì—… ë‚´ìš© ìƒì„±
        const riskInfo = loc.riskAssessment || {};
        // threat_level ì‚¬ìš©
        const displayThreatLevel = riskInfo.threat_level || (riskLevel === 'unclassified' ? 'ë¯¸ë¶„ë¥˜' : getRiskLevelName(riskLevel));
        const riskBadge = `
          <div style="margin-bottom: 12px; padding: 8px 12px; background: ${riskInfo.risk_level_color || RISK_CONFIG[riskLevel].color || '#1E40AF'}; color: white; border-radius: 8px; font-weight: 600; font-size: 13px; text-align: center;">
            ${displayThreatLevel}
          </div>
        `;

        const speciesInfo = loc.classification ? `
          <p style="margin: 8px 0; font-size: 13px; color: #6B7280;">
            <strong>ì¢…:</strong> ${loc.classification.korean_name || loc.classification.species || 'ë¯¸ë¶„ë¥˜'}
          </p>
        ` : '<p style="margin: 8px 0; font-size: 13px; color: #6B7280;"><strong>ì¢…:</strong> ë¯¸ë¶„ë¥˜</p>';

        const description = riskInfo.description ? `
          <p style="margin: 8px 0; font-size: 12px; color: #374151; background: #F9FAFB; padding: 8px; border-radius: 6px;">
            ${riskInfo.description}
          </p>
        ` : '';

        const popupContent = `
          <div class="popup-content" style="max-width: 280px;">
            ${riskBadge}
            <h3 style="font-size: 14px; margin-bottom: 8px;">${loc.filename}</h3>
            <img src="${loc.imageUrl}" alt="${loc.filename}" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;" />
            ${speciesInfo}
            <p style="margin: 4px 0; font-size: 11px; color: #6B7280;">ìœ„ë„: ${loc.lat.toFixed(6)}</p>
            <p style="margin: 4px 0; font-size: 11px; color: #6B7280;">ê²½ë„: ${loc.lon.toFixed(6)}</p>
            ${description}
            <a href="${loc.mapsUrl}" target="_blank" style="display: inline-block; margin-top: 8px; padding: 8px 16px; background: #3182F6; color: white; text-decoration: none; border-radius: 8px; font-size: 12px; font-weight: 600;">Google Mapsì—ì„œ ë³´ê¸° â†’</a>
          </div>
        `;

        // íŒì—… ë°”ì¸ë”©
        marker.bindPopup(popupContent, {
          maxWidth: 280,
          className: 'custom-popup',
          maxHeight: 500
        });

        // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
        marker.on('click', function() {
          highlightImageItem(index);
        });

        return marker;
      }

      // ë§ˆì»¤ í‘œì‹œ í•¨ìˆ˜
      function showMarker(index) {
        // allMarkersì—ì„œ ì°¾ê¸°
        const markerData = allMarkers.find(m => m.index === index);
        if (markerData) {
          // ì§€ë„ ì¤‘ì‹¬ì„ í•´ë‹¹ ë§ˆì»¤ë¡œ ì´ë™
          map.setView([markerData.marker.getLatLng().lat, markerData.marker.getLatLng().lng], 15, {
            animate: true,
            duration: 0.5
          });
          
          // íŒì—… ì—´ê¸°
          markerData.marker.openPopup();
          
          // ì´ë¯¸ì§€ ì•„ì´í…œ í•˜ì´ë¼ì´íŠ¸
          highlightImageItem(index);
        }
      }

      // ìœ„ì¹˜ ì˜µì…˜ ëª¨ë‹¬ í‘œì‹œ
      function showLocationOptions() {
        const modal = document.getElementById('locationOptionsModal');
        if (modal) {
          modal.classList.add('show');
          document.body.style.overflow = 'hidden';
        }
      }

      // ìœ„ì¹˜ ì˜µì…˜ ëª¨ë‹¬ ë‹«ê¸°
      function closeLocationOptionsModal() {
        const modal = document.getElementById('locationOptionsModal');
        if (modal) {
          modal.classList.remove('show');
          document.body.style.overflow = 'auto';
        }
      }

      // ìœ„ì¹˜ ë§ˆì»¤ ì„¤ì • (ê³µí†µ í•¨ìˆ˜)
      function setLocationMarker(lat, lng, accuracy = null) {
        // ê¸°ì¡´ í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì œê±°
        if (currentLocationMarker) {
          map.removeLayer(currentLocationMarker);
        }

        // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ìƒì„± (ì‚¬ëŒ ì•„ì´ì½˜)
        const currentLocationIcon = L.divIcon({
          className: 'current-location-marker',
          html: '<div class="current-location-marker">ğŸ‘¤</div>',
          iconSize: [32, 32],
          iconAnchor: [16, 16]
        });

        currentLocationMarker = L.marker([lat, lng], {
          icon: currentLocationIcon,
          zIndexOffset: 2000
        }).addTo(map);

        // í˜„ì¬ ìœ„ì¹˜ ì •ë³´ íŒì—…
        let accuracyText = '';
        if (accuracy !== null) {
          accuracyText = `<p style="margin: 4px 0; font-size: 11px; color: #9CA3AF;">ì •í™•ë„: ì•½ ${Math.round(accuracy)}m</p>`;
        } else {
          accuracyText = '<p style="margin: 4px 0; font-size: 11px; color: #9CA3AF;">ëŒ€ëµì ì¸ ìœ„ì¹˜ì…ë‹ˆë‹¤</p>';
        }

        const popupContent = `
          <div style="text-align: center; padding: 8px;">
            <h3 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600;">ğŸ“ í˜„ì¬ ìœ„ì¹˜</h3>
            <p style="margin: 4px 0; font-size: 12px; color: #6B7280;">ìœ„ë„: ${lat.toFixed(6)}</p>
            <p style="margin: 4px 0; font-size: 12px; color: #6B7280;">ê²½ë„: ${lng.toFixed(6)}</p>
            ${accuracyText}
          </div>
        `;

        currentLocationMarker.bindPopup(popupContent).openPopup();

        // ì§€ë„ë¥¼ í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™
        map.setView([lat, lng], 15, {
          animate: true,
          duration: 0.5
        });

        // ëª¨ë‹¬ ë‹«ê¸°
        closeLocationOptionsModal();
      }

      // IP ê¸°ë°˜ ìœ„ì¹˜ ì¶”ì •
      async function getLocationByIP() {
        const btn = document.querySelector('.current-location-btn');
        
        // ë²„íŠ¼ ë¡œë”© ìƒíƒœ
        btn.classList.add('loading');
        btn.textContent = 'â³';

        try {
          // ë¬´ë£Œ IP ìœ„ì¹˜ API ì‚¬ìš© (ip-api.com)
          const response = await fetch('http://ip-api.com/json/?fields=status,message,lat,lon,city,country');
          const data = await response.json();

          if (data.status === 'success') {
            setLocationMarker(data.lat, data.lon);
          } else {
            throw new Error(data.message || 'ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }
        } catch (error) {
          console.error('IP ìœ„ì¹˜ ì¶”ì • ì˜¤ë¥˜:', error);
          // ëŒ€ì²´ API ì‹œë„ (ipapi.co)
          try {
            const response2 = await fetch('https://ipapi.co/json/');
            const data2 = await response2.json();
            
            if (data2.latitude && data2.longitude) {
              setLocationMarker(data2.latitude, data2.longitude);
            } else {
              throw new Error('ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
          } catch (error2) {
            showLocationErrorModal(
              'ìœ„ì¹˜ ì •ë³´ ì˜¤ë¥˜',
              'IP ê¸°ë°˜ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
              ['ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'ë‹¤ë¥¸ ë°©ë²•ì„ ì‹œë„í•´ì£¼ì„¸ìš”.'],
              true
            );
          }
        } finally {
          // ë²„íŠ¼ ìƒíƒœ ë³µì›
          btn.classList.remove('loading');
          btn.textContent = 'ğŸ“';
        }
      }

      // ì§€ë„ í´ë¦­ìœ¼ë¡œ ìœ„ì¹˜ ì„ íƒ
      let mapClickLocationEnabled = false;
      function enableMapClickLocation() {
        closeLocationOptionsModal();
        
        if (!map) {
          alert('ì§€ë„ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
          return;
        }

        mapClickLocationEnabled = true;
        
        // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        map.once('click', function(e) {
          const lat = e.latlng.lat;
          const lng = e.latlng.lng;
          setLocationMarker(lat, lng);
          mapClickLocationEnabled = false;
        });

        // ì•ˆë‚´ ë©”ì‹œì§€
        alert('ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ìœ„ì¹˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      }

      // ìœ„ì¹˜ ê¶Œí•œ ìš”ì²­ ëª¨ë‹¬ í‘œì‹œ (GPS ì‚¬ìš©)
      function getCurrentLocation() {
        if (!navigator.geolocation) {
          alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
        }

        // ëª¨ë‹¬ í‘œì‹œ
        const modal = document.getElementById('locationPermissionModal');
        if (modal) {
          modal.classList.add('show');
          document.body.style.overflow = 'hidden';
        }
      }

      // ìœ„ì¹˜ ê¶Œí•œ ìš”ì²­ ëª¨ë‹¬ ë‹«ê¸°
      function closeLocationPermissionModal() {
        const modal = document.getElementById('locationPermissionModal');
        if (modal) {
          modal.classList.remove('show');
          document.body.style.overflow = 'auto';
        }
      }

      // ìœ„ì¹˜ ì˜¤ë¥˜ ëª¨ë‹¬ í‘œì‹œ
      function showLocationErrorModal(title, message, instructions, showInstructions) {
        const modal = document.getElementById('locationErrorModal');
        const titleEl = document.getElementById('locationErrorTitle');
        const messageEl = document.getElementById('locationErrorMessage');
        const instructionsEl = document.getElementById('locationErrorInstructions');

        if (modal && titleEl && messageEl && instructionsEl) {
          titleEl.textContent = title;
          messageEl.textContent = message;

          if (showInstructions && instructions && instructions.length > 0) {
            instructionsEl.style.display = 'block';
            instructionsEl.innerHTML = '';
            instructions.forEach(instruction => {
              const li = document.createElement('li');
              li.textContent = instruction;
              instructionsEl.appendChild(li);
            });
          } else {
            instructionsEl.style.display = 'none';
          }

          modal.classList.add('show');
          document.body.style.overflow = 'hidden';
        }
      }

      // ìœ„ì¹˜ ì˜¤ë¥˜ ëª¨ë‹¬ ë‹«ê¸°
      function closeLocationErrorModal() {
        const modal = document.getElementById('locationErrorModal');
        if (modal) {
          modal.classList.remove('show');
          document.body.style.overflow = 'auto';
        }
      }

      // ì‹¤ì œ ìœ„ì¹˜ ê¶Œí•œ ìš”ì²­ ë° ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
      function requestLocationPermission() {
        const btn = document.querySelector('.current-location-btn');
        
        // ëª¨ë‹¬ ë‹«ê¸°
        closeLocationPermissionModal();
        closeLocationOptionsModal();

        // ë²„íŠ¼ ë¡œë”© ìƒíƒœ
        btn.classList.add('loading');
        btn.textContent = 'â³';

        navigator.geolocation.getCurrentPosition(
          function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            setLocationMarker(lat, lng, accuracy);

            // ë²„íŠ¼ ìƒíƒœ ë³µì›
            btn.classList.remove('loading');
            btn.textContent = 'ğŸ“';
          },
          function(error) {
            // ë²„íŠ¼ ìƒíƒœ ë³µì›
            btn.classList.remove('loading');
            btn.textContent = 'ğŸ“';

            let errorMessage = 'ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            let errorTitle = 'ìœ„ì¹˜ ì •ë³´ ì˜¤ë¥˜';
            let errorInstructions = [];
            let showInstructions = false;

            switch(error.code) {
              case error.PERMISSION_DENIED:
                errorTitle = 'ìœ„ì¹˜ ê¶Œí•œ í•„ìš”';
                errorMessage = 'ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.';
                errorInstructions = [
                  'ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.',
                  'ì„¤ì • ë°©ë²•:',
                  '1. ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ ì™¼ìª½ì˜ ìë¬¼ì‡  ì•„ì´ì½˜ í´ë¦­',
                  '2. "ìœ„ì¹˜" ê¶Œí•œì„ "í—ˆìš©"ìœ¼ë¡œ ë³€ê²½'
                ];
                showInstructions = true;
                break;
              case error.POSITION_UNAVAILABLE:
                errorMessage = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                errorInstructions = ['GPS ì‹ í˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'];
                showInstructions = true;
                break;
              case error.TIMEOUT:
                errorMessage = 'ìœ„ì¹˜ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.';
                errorInstructions = ['ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'];
                showInstructions = true;
                break;
            }

            // ì˜¤ë¥˜ ëª¨ë‹¬ í‘œì‹œ
            showLocationErrorModal(errorTitle, errorMessage, errorInstructions, showInstructions);
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          }
        );
      }

      // í•„í„° ëª¨ë‹¬ í† ê¸€
      function toggleFilterModal() {
        const modal = document.getElementById('filterModal');
        if (modal) {
          modal.classList.add('show');
          document.body.style.overflow = 'hidden';
        }
      }

      function closeFilterModal() {
        const modal = document.getElementById('filterModal');
        if (modal) {
          modal.classList.remove('show');
          document.body.style.overflow = 'auto';
        }
      }

      // í•„í„° ì ìš©
      function applyFilters() {
        const checkboxes = document.querySelectorAll('.filter-option input[type="checkbox"]');
        const selectedFilters = Array.from(checkboxes)
          .filter(cb => cb.checked)
          .map(cb => cb.value);

        // ì„ íƒëœ í•„í„° í‘œì‹œ ì—…ë°ì´íŠ¸
        const selectedFiltersDiv = document.getElementById('selectedFilters');
        if (selectedFilters.length === 6) {
          selectedFiltersDiv.innerHTML = '<span style="font-size: 13px; color: var(--text-secondary);">ëª¨ë“  ìœ„í—˜ë„ í‘œì‹œ ì¤‘</span>';
        } else if (selectedFilters.length === 0) {
          selectedFiltersDiv.innerHTML = '<span style="font-size: 13px; color: var(--text-secondary);">í•„í„° ì—†ìŒ</span>';
        } else {
          const filterNames = {
            'critical': 'ğŸ”´ ì¸ì²´ ê³ ìœ„í—˜',
            'danger': 'ğŸŸ  ì¸ì²´ ì¤‘ìœ„í—˜',
            'caution': 'ğŸŸ¡ ë°˜ë ¤ë™ë¬¼ ìœ„í—˜',
            'safe': 'ğŸŸ¢ ì¼ë°˜Â·ë¶ˆì¾Œ',
            'unknown': 'âšª ë³´í˜¸ í•„ìš”',
            'unclassified': 'ğŸ”µ ë¯¸ë¶„ë¥˜'
          };
          selectedFiltersDiv.innerHTML = selectedFilters
            .map(f => `<span style="background: var(--primary-light); color: var(--primary-color); padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;">${filterNames[f]}</span>`)
            .join('');
        }

        // ë§ˆì»¤ í•„í„°ë§
        allMarkers.forEach(markerData => {
          const loc = markerData.location;
          let riskLevel = 'unclassified';

          if (loc.classification && loc.classification.threat_level) {
            const threatLevel = loc.classification.threat_level;
            if (threatLevel.includes('ì¸ì²´ ê³ ìœ„í—˜') || threatLevel.includes('ê³µê²©ì„±Â·ë…ì„±')) {
              riskLevel = 'critical';
            } else if (threatLevel.includes('ì¸ì²´ ì¤‘ìœ„í—˜') || threatLevel.includes('ë…ì„±Â·í”¼ë¶€ì—¼') || threatLevel.includes('ì§ˆë³‘ ë§¤ê°œ')) {
              riskLevel = 'danger';
            } else if (threatLevel.includes('ë°˜ë ¤ë™ë¬¼ ìœ„í—˜')) {
              riskLevel = 'caution';
            } else if (threatLevel.includes('ì¼ë°˜Â·ë¶ˆì¾Œ') || threatLevel.includes('ë¶ˆì¾Œ ê³¤ì¶©')) {
              riskLevel = 'safe';
            } else if (threatLevel.includes('ë³´í˜¸') || threatLevel.includes('ì²œì—°ê¸°ë…ë¬¼')) {
              riskLevel = 'unknown';
            }
          } else if (loc.riskAssessment && loc.riskAssessment.threat_level) {
            const threatLevel = loc.riskAssessment.threat_level;
            if (threatLevel.includes('ì¸ì²´ ê³ ìœ„í—˜') || threatLevel.includes('ê³µê²©ì„±Â·ë…ì„±')) {
              riskLevel = 'critical';
            } else if (threatLevel.includes('ì¸ì²´ ì¤‘ìœ„í—˜') || threatLevel.includes('ë…ì„±Â·í”¼ë¶€ì—¼') || threatLevel.includes('ì§ˆë³‘ ë§¤ê°œ')) {
              riskLevel = 'danger';
            } else if (threatLevel.includes('ë°˜ë ¤ë™ë¬¼ ìœ„í—˜')) {
              riskLevel = 'caution';
            } else if (threatLevel.includes('ì¼ë°˜Â·ë¶ˆì¾Œ') || threatLevel.includes('ë¶ˆì¾Œ ê³¤ì¶©')) {
              riskLevel = 'safe';
            } else if (threatLevel.includes('ë³´í˜¸') || threatLevel.includes('ì²œì—°ê¸°ë…ë¬¼')) {
              riskLevel = 'unknown';
            } else if (threatLevel === 'ë¯¸ë¶„ë¥˜') {
              riskLevel = 'unclassified';
            }
          }

          // í•„í„°ì— í¬í•¨ë˜ë©´ í‘œì‹œ, ì•„ë‹ˆë©´ ìˆ¨ê¹€
          if (selectedFilters.includes(riskLevel)) {
            if (!map.hasLayer(markerData.marker)) {
              markerData.marker.addTo(map);
            }
          } else {
            if (map.hasLayer(markerData.marker)) {
              map.removeLayer(markerData.marker);
            }
          }
        });

        // ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸ í•„í„°ë§
        document.querySelectorAll('.image-item').forEach(item => {
          const riskLevel = item.getAttribute('data-risk-level');
          if (selectedFilters.includes(riskLevel)) {
            item.style.display = 'flex';
          } else {
            item.style.display = 'none';
          }
        });

        closeFilterModal();
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§€ë„ ì´ˆê¸°í™”
      window.addEventListener('DOMContentLoaded', function() {
        initMap();
      });
    </script>
  {% endif %}

  <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <div class="bottom-nav">
    <a href="{{ url_for('board_page') }}" class="nav-item">
      <div class="nav-icon">ğŸ“‹</div>
      <div>ê²Œì‹œíŒ</div>
    </a>
    <a href="{{ url_for('index') }}" class="nav-item">
      <div class="nav-icon">ğŸ“·</div>
      <div>ì´¬ì˜</div>
    </a>
    <a href="{{ url_for('map_page') }}" class="nav-item active">
      <div class="nav-icon">ğŸ—ºï¸</div>
      <div>ì§€ë„</div>
    </a>
  </div>

  <script>
    function openMyPage() {
      alert('ë§ˆì´í˜ì´ì§€ëŠ” ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
    }

    function showRiskCriteria() {
      const modal = document.getElementById('riskCriteriaModal');
      if (modal) {
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
      }
    }

    function closeRiskCriteria() {
      const modal = document.getElementById('riskCriteriaModal');
      if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = 'auto';
      }
    }

    function closeRiskCriteriaOnBackdrop(event) {
      if (event.target.id === 'riskCriteriaModal') {
        closeRiskCriteria();
      }
    }

    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeRiskCriteria();
        closeLocationPermissionModal();
        closeLocationErrorModal();
      }
    });
  </script>
</body>
</html>
