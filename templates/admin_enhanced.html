<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€ - ê°•í™”ëœ ë³´ì•ˆ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .admin-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; border: 1px solid #ddd; background: white; cursor: pointer; }
        .tab-btn.active { background: #3182f6; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .user-form { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-row input, .form-row select { padding: 12px; font-size: 14px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        .data-table th { background: #f8f9fa; }
        .btn-small { padding: 5px 10px; font-size: 12px; margin: 2px; }
        .image-preview { max-width: 100px; max-height: 100px; object-fit: cover; }
        .security-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .ip-code { background: #f8f9fa; padding: 2px 6px; border-radius: 3px; font-family: monospace; }
        .attempts-badge { background: #e74c3c; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; }
        .auto-badge { background: #f39c12; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; }
        .manual-badge { background: #3498db; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; }
        .malicious-reason { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">ğŸ› ï¸ ê´€ë¦¬ì í˜ì´ì§€ - ê°•í™”ëœ ë³´ì•ˆ</h1>
        <div class="nav-links">
            <a href="/" class="nav-link">íƒì§€/ë¶„ë¥˜</a>
            <a href="/labeling_detection" class="nav-link">íƒì§€ ëª¨ë¸ ë¼ë²¨ë§</a>
            <a href="/labeling_classification" class="nav-link">ë¶„ë¥˜ ëª¨ë¸ ë¼ë²¨ë§</a>
            <a href="/data_viewer" class="nav-link">ë°ì´í„° ì¡°íšŒ</a>
            <a href="/admin" class="nav-link active">ê´€ë¦¬ì</a>
        </div>
    </div>

    <div class="admin-container">
        <div class="admin-tabs">
            <button class="tab-btn active" onclick="showTab('security')">ğŸš« ë³´ì•ˆ ê´€ë¦¬</button>
            <button class="tab-btn" onclick="showTab('users')">ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</button>
            <button class="tab-btn" onclick="showTab('data')">ğŸ“Š ë°ì´í„° ê´€ë¦¬</button>
            <button class="tab-btn" onclick="showTab('whitelist')">âœ… í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸</button>
        </div>

        <!-- ë³´ì•ˆ ê´€ë¦¬ íƒ­ (ê¸°ë³¸ í™œì„±í™”) -->
        <div id="security-tab" class="tab-content active">
            <div style="margin-bottom: 20px;">
                <h3>ğŸš« ë¸”ë™ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬ (ê°•í™”ëœ ë²„ì „)</h3>
                <div style="margin-bottom: 10px;">
                    <button onclick="loadBlacklist()" class="btn btn-secondary">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                    <button onclick="addManualBlock()" class="btn btn-primary">â• ìˆ˜ë™ ì°¨ë‹¨ ì¶”ê°€</button>
                    <button onclick="clearAllBlacklist()" class="btn btn-danger">ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
                </div>
                <div class="security-info">
                    <h4>ğŸ¤– ìë™ ì°¨ë‹¨ íŒ¨í„´:</h4>
                    <ul style="margin: 10px 0; font-size: 14px; color: #666;">
                        <li><strong>ì•…ì„± ê²½ë¡œ:</strong> /wp-admin, /phpmyadmin, /.env, /shell, /cmd, /eval ë“±</li>
                        <li><strong>ì•…ì„± ë©”ì†Œë“œ:</strong> CONNECT, TRACE, TRACK</li>
                        <li><strong>ì•…ì„± User-Agent:</strong> bot, crawler, scanner, exploit ë„êµ¬ ë“±</li>
                        <li><strong>ê³µê²© íŒ¨í„´:</strong> SQL ì¸ì ì…˜, XSS, ë””ë ‰í† ë¦¬ ìˆœíšŒ, ëª…ë ¹ì–´ ì¸ì ì…˜</li>
                        <li><strong>ë¹„ì •ìƒ ìš”ì²­:</strong> í”„ë¡ì‹œ í—¤ë”, ë°”ì´ë„ˆë¦¬ ë°ì´í„°, TLS handshake</li>
                    </ul>
                </div>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>IP ì£¼ì†Œ</th>
                        <th>ì°¨ë‹¨ ì‚¬ìœ </th>
                        <th>ì‹œë„ íšŸìˆ˜</th>
                        <th>ì°¨ë‹¨ ì‹œê°„</th>
                        <th>ë§ˆì§€ë§‰ ì‹œë„</th>
                        <th>ì°¨ë‹¨ ë°©ì‹</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="blacklistTable"></tbody>
            </table>
        </div>

        <!-- ì‚¬ìš©ì ê´€ë¦¬ íƒ­ -->
        <div id="users-tab" class="tab-content">
            <div class="user-form">
                <h3>ìƒˆ ì‚¬ìš©ì ì¶”ê°€</h3>
                <form id="userForm">
                    <div class="form-row">
                        <input type="text" id="username" placeholder="ì‚¬ìš©ìëª…" required>
                        <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
                        <input type="text" id="name" placeholder="ì´ë¦„" required>
                        <select id="role">
                            <option value="reviewer">ê²€ìˆ˜ì</option>
                            <option value="admin">ê´€ë¦¬ì</option>
                        </select>
                        <input type="email" id="email" placeholder="ì´ë©”ì¼">
                    </div>
                    <button type="submit" class="btn btn-primary">ì‚¬ìš©ì ì¶”ê°€</button>
                </form>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ì‚¬ìš©ìëª…</th>
                        <th>ì´ë¦„</th>
                        <th>ì—­í• </th>
                        <th>ì´ë©”ì¼</th>
                        <th>ìƒíƒœ</th>
                        <th>ë§ˆì§€ë§‰ ë¡œê·¸ì¸</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="usersTable"></tbody>
            </table>
        </div>

        <!-- ë°ì´í„° ê´€ë¦¬ íƒ­ -->
        <div id="data-tab" class="tab-content">
            <div style="margin-bottom: 20px;">
                <input type="text" id="searchInput" placeholder="ê²€ìƒ‰..." style="padding: 8px; width: 300px;" onkeyup="handleSearch(event)">
                <select id="typeFilter" style="padding: 8px;" onchange="loadLabeledData()">
                    <option value="">ëª¨ë“  íƒ€ì…</option>
                    <option value="detection">íƒì§€</option>
                    <option value="classification">ë¶„ë¥˜</option>
                </select>
                <button onclick="loadLabeledData()" class="btn btn-secondary">ìƒˆë¡œê³ ì¹¨</button>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>ì´ë¯¸ì§€</th>
                        <th>íŒŒì¼ëª…</th>
                        <th>íƒ€ì…</th>
                        <th>ë¶„ë¥˜ ì •ë³´</th>
                        <th>ê²€ìˆ˜ì</th>
                        <th>ìƒì„±ì¼</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="dataTable"></tbody>
            </table>
        </div>

        <!-- í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬ íƒ­ -->
        <div id="whitelist-tab" class="tab-content">
            <div class="user-form">
                <h3>âœ… ìƒˆ IP ì£¼ì†Œ ì¶”ê°€</h3>
                <form id="whitelistForm">
                    <div class="form-row">
                        <input type="text" id="ipAddress" placeholder="IP ì£¼ì†Œ (ì˜ˆ: 192.168.1.100 ë˜ëŠ” 192.168.0.0/16)" required>
                        <input type="text" id="description" placeholder="ì„¤ëª… (ì„ íƒì‚¬í•­)">
                        <button type="submit" class="btn btn-primary">ì¶”ê°€</button>
                    </div>
                </form>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>IP ì£¼ì†Œ/ëŒ€ì—­</th>
                        <th>ì„¤ëª…</th>
                        <th>ì¶”ê°€ ì‹œê°„</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="whitelistTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'users') loadUsers();
            if (tabName === 'data') loadLabeledData();
            if (tabName === 'security') loadBlacklist();
            if (tabName === 'whitelist') loadWhitelist();
        }

        async function loadBlacklist() {
            try {
                const response = await fetch('/api/admin/blacklist');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                const blacklistData = result.blacklist || {};
                const tbody = document.getElementById('blacklistTable');
                
                if (Object.keys(blacklistData).length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">ì°¨ë‹¨ëœ IPê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                } else {
                    tbody.innerHTML = Object.entries(blacklistData).map(([ip, info]) => {
                        const blockTime = info.first_blocked || info.blocked_at || info.last_attempt;
                        const lastAttempt = info.last_attempt;
                        const blockedBy = info.blocked_by || 'unknown';
                        const reasonClass = info.reason && info.reason.includes('ì•…ì„±') ? 'malicious-reason' : '';
                        
                        return `
                        <tr>
                            <td><code class="ip-code">${ip}</code></td>
                            <td class="${reasonClass}">${info.reason || 'ìƒì„¸ ì •ë³´ ì—†ìŒ'}</td>
                            <td><span class="attempts-badge">${info.attempts || 1}</span></td>
                            <td>${blockTime ? new Date(blockTime).toLocaleString() : 'ì•Œ ìˆ˜ ì—†ìŒ'}</td>
                            <td>${lastAttempt ? new Date(lastAttempt).toLocaleString() : '-'}</td>
                            <td><span class="${blockedBy === 'auto_detection' ? 'auto-badge' : 'manual-badge'}">${blockedBy === 'auto_detection' ? 'ìë™ê°ì§€' : 'ìˆ˜ë™ì¶”ê°€'}</span></td>
                            <td>
                                <button class="btn btn-small btn-success" onclick="unblockIP('${ip}')">ì°¨ë‹¨í•´ì œ</button>
                                <button class="btn btn-small btn-info" onclick="showIPDetails('${ip}', ${JSON.stringify(info).replace(/"/g, '&quot;')})">ìƒì„¸ì •ë³´</button>
                            </td>
                        </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('blacklistTable').innerHTML = 
                    '<tr><td colspan="7" style="text-align: center; color: red;">ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ' + error.message + '</td></tr>';
            }
        }
        
        function addManualBlock() {
            const ip = prompt('IP ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            if (!ip) return;
            
            const reason = prompt('ì°¨ë‹¨ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', 'ê´€ë¦¬ì ìˆ˜ë™ ì°¨ë‹¨');
            if (!reason) return;
            
            fetch('/api/admin/blacklist', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ip: ip, reason: reason })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('âœ… ' + result.message);
                    loadBlacklist();
                } else {
                    alert('âŒ ì¶”ê°€ ì‹¤íŒ¨: ' + result.error);
                }
            })
            .catch(error => {
                alert('âŒ ì¶”ê°€ ì‹¤íŒ¨: ' + error.message);
            });
        }
        
        function showIPDetails(ip, info) {
            const details = `
ğŸ“Š IP ìƒì„¸ ì •ë³´: ${ip}

ì°¨ë‹¨ ì‚¬ìœ : ${info.reason || 'ì•Œ ìˆ˜ ì—†ìŒ'}
ì‹œë„ íšŸìˆ˜: ${info.attempts || 1}
ì²˜ìŒ ì°¨ë‹¨: ${info.first_blocked ? new Date(info.first_blocked).toLocaleString() : 'ì•Œ ìˆ˜ ì—†ìŒ'}
ë§ˆì§€ë§‰ ì‹œë„: ${info.last_attempt ? new Date(info.last_attempt).toLocaleString() : 'ì•Œ ìˆ˜ ì—†ìŒ'}
ë©”ì†Œë“œ: ${info.method || 'ì•Œ ìˆ˜ ì—†ìŒ'}
URL: ${info.url || 'ì•Œ ìˆ˜ ì—†ìŒ'}
User-Agent: ${info.user_agent || 'ì•Œ ìˆ˜ ì—†ìŒ'}
ì°¨ë‹¨ ë°©ì‹: ${info.blocked_by === 'auto_detection' ? 'ìë™ ê°ì§€' : 'ìˆ˜ë™ ì¶”ê°€'}
            `;
            alert(details);
        }

        async function unblockIP(ip) {
            if (!confirm(`âš ï¸ IP ${ip}ì˜ ì°¨ë‹¨ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní•´ì œ í›„ í•´ë‹¹ IPì—ì„œ ë‹¤ì‹œ ì•…ì„± ìš”ì²­ì´ ì˜¤ë©´ ìë™ìœ¼ë¡œ ë‹¤ì‹œ ì°¨ë‹¨ë©ë‹ˆë‹¤.`)) return;
            
            try {
                const response = await fetch(`/api/admin/blacklist/${ip}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('âœ… ì°¨ë‹¨ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadBlacklist();
                } else {
                    alert('âŒ ì°¨ë‹¨ í•´ì œ ì‹¤íŒ¨');
                }
            } catch (error) {
                alert('âŒ ì°¨ë‹¨ í•´ì œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        function clearAllBlacklist() {
            if (!confirm('âš ï¸ ëª¨ë“  ë¸”ë™ë¦¬ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
            
            // êµ¬í˜„ í•„ìš” ì‹œ API ì¶”ê°€
            alert('ì´ ê¸°ëŠ¥ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }

        // ê¸°ì¡´ í•¨ìˆ˜ë“¤ (ì‚¬ìš©ì, ë°ì´í„°, í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬)
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                const users = await response.json();
                
                const tbody = document.getElementById('usersTable');
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.name}</td>
                        <td>${user.role}</td>
                        <td>${user.email || ''}</td>
                        <td>${user.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}</td>
                        <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'ì—†ìŒ'}</td>
                        <td>
                            ${user.username === 'esemoon' ? '<span style="color: #666; font-size: 12px;">ë©”ì¸ ê´€ë¦¬ì</span>' : `<button class="btn btn-small btn-danger" onclick="deleteUser(${user.id})">ì‚­ì œ</button>`}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                alert('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        async function loadLabeledData(page = 1) {
            // ê¸°ì¡´ êµ¬í˜„ ìœ ì§€
            alert('ë°ì´í„° ê´€ë¦¬ ê¸°ëŠ¥ì€ ê¸°ì¡´ ê´€ë¦¬ì í˜ì´ì§€ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.');
        }

        async function loadWhitelist() {
            try {
                const response = await fetch('/api/admin/whitelist');
                const whitelist = await response.json();
                
                const tbody = document.getElementById('whitelistTable');
                if (whitelist.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">ë“±ë¡ëœ IPê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                } else {
                    tbody.innerHTML = whitelist.map(item => `
                        <tr>
                            <td><code class="ip-code">${item.ip_address}</code></td>
                            <td>${item.description || 'ì„¤ëª… ì—†ìŒ'}</td>
                            <td>${new Date(item.created_at).toLocaleString()}</td>
                            <td>
                                ${item.is_default ? '<span style="color: #666; font-size: 12px;">ê¸°ë³¸ ì„¤ì •</span>' : `<button class="btn btn-small btn-danger" onclick="removeFromWhitelist('${item.ip_address}')">ì‚­ì œ</button>`}
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('whitelistTable').innerHTML = 
                    '<tr><td colspan="4" style="text-align: center; color: red;">í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨</td></tr>';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë³´ì•ˆ ê´€ë¦¬ íƒ­ ë¡œë“œ
        loadBlacklist();
    </script>
    
    <!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
    <a href="/logout" style="position: fixed; bottom: 20px; right: 20px; background: #e74c3c; color: white; padding: 10px 15px; border-radius: 50px; text-decoration: none; font-size: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 9999;">ğŸšª ë¡œê·¸ì•„ì›ƒ</a>
</body>
</html>