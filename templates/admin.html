<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .admin-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; border: 1px solid #ddd; background: white; cursor: pointer; }
        .tab-btn.active { background: #3182f6; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .user-form { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-row input, .form-row select { padding: 12px; font-size: 14px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        .data-table th { background: #f8f9fa; }
        .btn-small { padding: 5px 10px; font-size: 12px; margin: 2px; }
        .image-preview { max-width: 100px; max-height: 100px; object-fit: cover; }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">ğŸ› ï¸ ê´€ë¦¬ì í˜ì´ì§€</h1>
        <div class="nav-links">
            <a href="/" class="nav-link">íƒì§€/ë¶„ë¥˜</a>
            <a href="/labeling_detection" class="nav-link">íƒì§€ ëª¨ë¸ ë¼ë²¨ë§</a>
            <a href="/labeling_classification" class="nav-link">ë¶„ë¥˜ ëª¨ë¸ ë¼ë²¨ë§</a>
            <a href="/data_viewer" class="nav-link">ë°ì´í„° ì¡°íšŒ</a>
            <a href="/admin" class="nav-link active">ê´€ë¦¬ì</a>
        </div>
    </div>

    <div class="admin-container">
        <div class="admin-tabs">
            <button class="tab-btn active" onclick="showTab('users')">ì‚¬ìš©ì ê´€ë¦¬</button>
            <button class="tab-btn" onclick="showTab('data')">ë¼ë²¨ë§ ë°ì´í„° ê´€ë¦¬</button>
            <button class="tab-btn" onclick="showTab('duplicates')">ì¤‘ë³µ íŒŒì¼ ê´€ë¦¬</button>
            <button class="tab-btn" onclick="showTab('security')">ë³´ì•ˆ ê´€ë¦¬</button>
            <button class="tab-btn" onclick="showTab('whitelist')">í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬</button>
        </div>

        <!-- ì‚¬ìš©ì ê´€ë¦¬ íƒ­ -->
        <div id="users-tab" class="tab-content active">
            <div class="user-form">
                <h3>ìƒˆ ì‚¬ìš©ì ì¶”ê°€</h3>
                <form id="userForm">
                    <div class="form-row">
                        <input type="text" id="username" placeholder="ì‚¬ìš©ìëª…" required>
                        <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
                        <input type="text" id="name" placeholder="ì´ë¦„" required>
                        <select id="role">
                            <option value="reviewer">ê²€ìˆ˜ì</option>
                            <option value="admin">ê´€ë¦¬ì</option>
                        </select>
                        <input type="email" id="email" placeholder="ì´ë©”ì¼">
                    </div>
                    <button type="submit" class="btn btn-primary">ì‚¬ìš©ì ì¶”ê°€</button>
                </form>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ì‚¬ìš©ìëª…</th>
                        <th>ì´ë¦„</th>
                        <th>ì—­í• </th>
                        <th>ì´ë©”ì¼</th>
                        <th>ìƒíƒœ</th>
                        <th>ë§ˆì§€ë§‰ ë¡œê·¸ì¸</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="usersTable"></tbody>
            </table>
        </div>

        <!-- ì¤‘ë³µ íŒŒì¼ ê´€ë¦¬ íƒ­ -->
        <div id="duplicates-tab" class="tab-content">
            <div style="margin-bottom: 20px;">
                <h3>ğŸ”„ ì¤‘ë³µ íŒŒì¼ ê´€ë¦¬</h3>
                <button onclick="checkDuplicates()" class="btn btn-primary">ì¤‘ë³µ ê²€ì‚¬</button>
                <button onclick="cleanDuplicates()" class="btn btn-warning">ì¤‘ë³µ ì¼ê´„ ì •ë¦¬</button>
                <a href="/admin/duplicates" class="btn btn-secondary" target="_blank">ìƒì„¸ ê´€ë¦¬ í˜ì´ì§€</a>
            </div>
            
            <div id="duplicatesSummary" style="display: none; background: #fff3cd; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                <h4>ì¤‘ë³µ ê²€ì‚¬ ê²°ê³¼</h4>
                <div id="duplicatesInfo"></div>
            </div>
            
            <div id="duplicatesLoading" style="display: none; text-align: center; padding: 20px;">
                <div class="spinner-border" role="status"></div>
                <p>ê²€ì‚¬ ì¤‘...</p>
            </div>
        </div>

        <!-- ë¼ë²¨ë§ ë°ì´í„° ê´€ë¦¬ íƒ­ -->
        <div id="data-tab" class="tab-content">
            <div class="stats" style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div class="stat-item">
                    <strong>ì´ ì´ë¯¸ì§€:</strong> <span id="adminTotalCount">0</span>ê°œ
                </div>
                <div class="stat-item">
                    <strong>ëª©:</strong> <span id="adminOrdersCount">0</span>ê°œ
                </div>
                <div class="stat-item">
                    <strong>ê³¼:</strong> <span id="adminFamiliesCount">0</span>ê°œ
                </div>
                <div class="stat-item">
                    <strong>ì†:</strong> <span id="adminGeneraCount">0</span>ê°œ
                </div>
                <div class="stat-item">
                    <strong>ì¢…:</strong> <span id="adminSpeciesCount">0</span>ê°œ
                </div>
                <div class="stat-item" style="width: 100%; margin-top: 10px;">
                    <strong>ëª© ë¶„í¬ ë¶„ì„:</strong>
                    <div id="adminOrdersDistribution" style="margin-top: 10px; max-height: 200px; overflow-y: auto; font-size: 12px;">
                        ë¡œë”© ì¤‘...
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <input type="text" id="searchInput" placeholder="ê²€ìƒ‰..." style="padding: 8px; width: 300px;" onkeyup="handleSearch(event)">
                <select id="typeFilter" style="padding: 8px;" onchange="loadLabeledData()">
                    <option value="">ëª¨ë“  íƒ€ì…</option>
                    <option value="detection">íƒì§€</option>
                    <option value="classification">ë¶„ë¥˜</option>
                </select>
                <button onclick="loadLabeledData()" class="btn btn-secondary">ìƒˆë¡œê³ ì¹¨</button>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>ì´ë¯¸ì§€</th>
                        <th>íŒŒì¼ëª…</th>
                        <th>íƒ€ì…</th>
                        <th>ë¶„ë¥˜ ì •ë³´</th>
                        <th>ê²€ìˆ˜ì</th>
                        <th>ìƒì„±ì¼</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="dataTable"></tbody>
            </table>
        </div>

        <!-- ë³´ì•ˆ ê´€ë¦¬ íƒ­ -->
        <div id="security-tab" class="tab-content">
            <div style="margin-bottom: 20px;">
                <h3>ğŸš« ë¸”ë™ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬ (ê°•í™”ëœ ë²„ì „)</h3>
                <div style="margin-bottom: 10px;">
                    <button onclick="loadBlacklist()" class="btn btn-secondary">ìƒˆë¡œê³ ì¹¨</button>
                    <button onclick="addManualBlock()" class="btn btn-primary">ìˆ˜ë™ ì°¨ë‹¨ ì¶”ê°€</button>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4>ìë™ ì°¨ë‹¨ íŒ¨í„´:</h4>
                    <ul style="margin: 10px 0; font-size: 14px; color: #666;">
                        <li>ì•…ì„± ê²½ë¡œ: /wp-admin, /phpmyadmin, /.env, /shell ë“±</li>
                        <li>ì•…ì„± ë©”ì†Œë“œ: CONNECT, TRACE, TRACK</li>
                        <li>ì•…ì„± User-Agent: bot, crawler, scanner, exploit ë„êµ¬ ë“±</li>
                        <li>SQL ì¸ì ì…˜, XSS, ë””ë ‰í† ë¦¬ ìˆœíšŒ, ëª…ë ¹ì–´ ì¸ì ì…˜ íŒ¨í„´</li>
                        <li>ë¹„ì •ìƒ í”„ë¡ì‹œ í—¤ë” ë° ë°”ì´ë„ˆë¦¬ ë°ì´í„°</li>
                    </ul>
                </div>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>IP ì£¼ì†Œ</th>
                        <th>ì°¨ë‹¨ ì‚¬ìœ </th>
                        <th>ì‹œë„ íšŸìˆ˜</th>
                        <th>ì°¨ë‹¨ ì‹œê°„</th>
                        <th>ë§ˆì§€ë§‰ ì‹œë„</th>
                        <th>ì°¨ë‹¨ ë°©ì‹</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="blacklistTable"></tbody>
            </table>
        </div>

        <!-- í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬ íƒ­ -->
        <div id="whitelist-tab" class="tab-content">
            <div class="user-form">
                <h3>âœ… ìƒˆ IP ì£¼ì†Œ ì¶”ê°€</h3>
                <form id="whitelistForm">
                    <div class="form-row">
                        <input type="text" id="ipAddress" placeholder="IP ì£¼ì†Œ (ì˜ˆ: 192.168.1.100 ë˜ëŠ” 192.168.0.0/16)" required>
                        <input type="text" id="description" placeholder="ì„¤ëª… (ì„ íƒì‚¬í•­)">
                        <button type="submit" class="btn btn-primary">ì¶”ê°€</button>
                    </div>
                </form>
            </div>

            <div style="margin-bottom: 20px;">
                <h3>âœ… í—ˆìš©ëœ IP ì£¼ì†Œ ëª©ë¡</h3>
                <button onclick="loadWhitelist()" class="btn btn-secondary">ìƒˆë¡œê³ ì¹¨</button>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>IP ì£¼ì†Œ/ëŒ€ì—­</th>
                        <th>ì„¤ëª…</th>
                        <th>ì¶”ê°€ ì‹œê°„</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="whitelistTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'users') loadUsers();
            if (tabName === 'data') {
                loadAdminTaxonomyStats();
                loadLabeledData();
            }
            if (tabName === 'duplicates') checkDuplicates();
            if (tabName === 'security') loadBlacklist();
            if (tabName === 'whitelist') loadWhitelist();
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                const users = await response.json();
                
                const tbody = document.getElementById('usersTable');
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.name}</td>
                        <td>${user.role}</td>
                        <td>${user.email || ''}</td>
                        <td>${user.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}</td>
                        <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'ì—†ìŒ'}</td>
                        <td>
                            ${user.username === 'esemoon' ? '<span style="color: #666; font-size: 12px;">ë©”ì¸ ê´€ë¦¬ì</span>' : `<button class="btn btn-small btn-danger" onclick="deleteUser(${user.id})">ì‚­ì œ</button>`}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                alert('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        let adminCurrentPage = 1;
        let adminTotalPages = 1;
        let adminCurrentPageGroup = 1;
        
        async function loadAdminTaxonomyStats() {
            try {
                const response = await fetch('/api/admin/taxonomy_stats');
                const stats = await response.json();
                
                if (stats.success) {
                    document.getElementById('adminTotalCount').textContent = stats.total_images;
                    document.getElementById('adminOrdersCount').textContent = stats.orders_count;
                    document.getElementById('adminFamiliesCount').textContent = stats.families_count;
                    document.getElementById('adminGeneraCount').textContent = stats.genera_count;
                    document.getElementById('adminSpeciesCount').textContent = stats.species_count;
                    
                    // ì „ì²´ ëª© ë¶„í¬ í‘œì‹œ
                    const ordersHtml = stats.all_orders.map((item, index) => 
                        `<div style="margin: 2px 0; padding: 2px 5px; background: ${index % 2 === 0 ? '#f8f9fa' : 'white'}; border-radius: 3px;">
                            ${index + 1}. <strong>${item.order}</strong>: ${item.count}ê°œ (${item.percentage}%)
                        </div>`
                    ).join('');
                    document.getElementById('adminOrdersDistribution').innerHTML = ordersHtml;
                }
            } catch (error) {
                console.error('ê´€ë¦¬ì í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        async function loadLabeledData(page = 1) {
            try {
                const searchQuery = document.getElementById('searchInput').value.trim();
                const typeFilter = document.getElementById('typeFilter').value;
                
                const params = new URLSearchParams();
                if (searchQuery) params.append('search', searchQuery);
                if (typeFilter) params.append('type', typeFilter);
                params.append('page', page);
                params.append('per_page', 10);
                
                const url = '/api/training_data?' + params.toString();
                const response = await fetch(url);
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error);
                }
                
                updateAdminPagination(result);
                
                const tbody = document.getElementById('dataTable');
                if (result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = result.data.map(item => {
                    let imageSrc;
                    if (item.pending_file_id && item.species_folder) {
                        const speciesFolder = item.species_folder;
                        const batchId = item.batch_id || 1;
                        imageSrc = `/api/storage-image/${batchId}/${speciesFolder}/${item.filename}`;
                    } else {
                        imageSrc = `/uploads/${item.filename}`;
                    }
                    
                    return `
                    <tr>
                        <td><img src="${imageSrc}" class="image-preview" alt="ì´ë¯¸ì§€"></td>
                        <td>${item.filename}</td>
                        <td>${item.image_type}</td>
                        <td>${item.scientific_name || item.korean_name || `${item.order_name} > ${item.family_name}`}</td>
                        <td>${item.reviewer_name}</td>
                        <td>${new Date(item.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-small btn-primary" onclick="editData(${item.id})">í¸ì§‘</button>
                            <button class="btn btn-small btn-danger" onclick="deleteData(${item.id})">ì‚­ì œ</button>
                        </td>
                    </tr>
                    `;
                }).join('');
            } catch (error) {
                alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        function updateAdminPagination(result) {
            adminCurrentPage = result.page;
            adminTotalPages = result.total_pages;
            adminCurrentPageGroup = Math.ceil(adminCurrentPage / 10);
            
            let paginationHtml = document.getElementById('adminPagination');
            if (!paginationHtml) {
                paginationHtml = document.createElement('div');
                paginationHtml.id = 'adminPagination';
                paginationHtml.style.cssText = 'margin: 20px 0; text-align: center;';
                document.getElementById('dataTable').parentNode.insertBefore(paginationHtml, document.getElementById('dataTable').nextSibling);
            }
            
            // ê·¸ë£¹ í™”ì‚´í‘œ ë²„íŠ¼
            let html = `<button onclick="adminPrevPageGroup()" ${adminCurrentPageGroup <= 1 ? 'disabled' : ''}>â—€</button>`;
            
            // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ (1-10, 11-20, ...)
            const startPage = (adminCurrentPageGroup - 1) * 10 + 1;
            const endPage = Math.min(adminCurrentPageGroup * 10, adminTotalPages);
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button onclick="loadLabeledData(${i})" style="margin: 0 2px; padding: 5px 10px; border: 1px solid #ddd; cursor: pointer; ${i === adminCurrentPage ? 'background: #007bff; color: white;' : 'background: white;'}">${i}</button>`;
            }
            
            html += `<button onclick="adminNextPageGroup()" ${adminCurrentPageGroup >= Math.ceil(adminTotalPages / 10) ? 'disabled' : ''}>â–¶</button>`;
            paginationHtml.innerHTML = html;
        }
        
        function adminPrevPageGroup() {
            if (adminCurrentPageGroup > 1) {
                const newPage = (adminCurrentPageGroup - 2) * 10 + 1;
                loadLabeledData(newPage);
            }
        }
        
        function adminNextPageGroup() {
            if (adminCurrentPageGroup < Math.ceil(adminTotalPages / 10)) {
                const newPage = adminCurrentPageGroup * 10 + 1;
                loadLabeledData(newPage);
            }
        }

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userData = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                name: document.getElementById('name').value,
                role: document.getElementById('role').value,
                email: document.getElementById('email').value
            };

            try {
                const response = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                if (response.ok) {
                    alert('ì‚¬ìš©ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    document.getElementById('userForm').reset();
                    loadUsers();
                } else {
                    const error = await response.json();
                    alert('ì‚¬ìš©ì ì¶”ê°€ ì‹¤íŒ¨: ' + error.error);
                }
            } catch (error) {
                alert('ì‚¬ìš©ì ì¶”ê°€ ì‹¤íŒ¨: ' + error.message);
            }
        });

        async function deleteUser(userId) {
            if (userId === 1) {
                alert('ë©”ì¸ ê´€ë¦¬ì ê³„ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const response = await fetch(`/api/admin/users/${userId}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadUsers();
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨');
                }
            } catch (error) {
                alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        async function editData(dataId) {
            try {
                // ë°ì´í„° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(`/api/admin/labeled-data/${dataId}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error);
                }
                
                // íƒ€ì…ì— ë”°ë¼ í•´ë‹¹ ë¼ë²¨ë§ í˜ì´ì§€ë¡œ ì´ë™
                if (data.image_type === 'detection') {
                    // íƒì§€ ë¼ë²¨ë§ í˜ì´ì§€ë¡œ ì´ë™ (ë°ì´í„° ì „ë‹¬)
                    const editUrl = `/labeling_detection?edit=${dataId}`;
                    window.open(editUrl, '_blank');
                } else if (data.image_type === 'classification') {
                    // ë¶„ë¥˜ ë¼ë²¨ë§ í˜ì´ì§€ë¡œ ì´ë™ (ë°ì´í„° ì „ë‹¬)
                    const editUrl = `/labeling_classification?edit=${dataId}`;
                    window.open(editUrl, '_blank');
                } else {
                    alert('ì•Œ ìˆ˜ ì—†ëŠ” ë°ì´í„° íƒ€ì…ì…ë‹ˆë‹¤.');
                }
            } catch (error) {
                alert('í¸ì§‘ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        async function deleteData(dataId) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const response = await fetch(`/api/admin/labeled-data/${dataId}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadLabeledData();
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨');
                }
            } catch (error) {
                alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        async function loadBlacklist() {
            try {
                const response = await fetch('/api/admin/blacklist');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                const blacklistData = result.blacklist || {};
                const tbody = document.getElementById('blacklistTable');
                
                if (Object.keys(blacklistData).length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">ì°¨ë‹¨ëœ IPê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                } else {
                    tbody.innerHTML = Object.entries(blacklistData).map(([ip, info]) => {
                        const blockTime = info.first_blocked || info.blocked_at || info.last_attempt;
                        return `
                        <tr>
                            <td><code>${ip}</code></td>
                            <td>${info.reason || 'ìƒì„¸ ì •ë³´ ì—†ìŒ'}</td>
                            <td>${info.attempts || 1}</td>
                            <td>${blockTime ? new Date(blockTime).toLocaleString() : 'ì•Œ ìˆ˜ ì—†ìŒ'}</td>
                            <td>
                                <button class="btn btn-small btn-success" onclick="unblockIP('${ip}')">ì°¨ë‹¨í•´ì œ</button>
                            </td>
                        </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('blacklistTable').innerHTML = 
                    '<tr><td colspan="5" style="text-align: center; color: red;">ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ' + error.message + '</td></tr>';
            }
        }

        function addManualBlock() {
            const ip = prompt('IP ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            if (!ip) return;
            
            const reason = prompt('ì°¨ë‹¨ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', 'ê´€ë¦¬ì ìˆ˜ë™ ì°¨ë‹¨');
            if (!reason) return;
            
            fetch('/api/admin/blacklist', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ip: ip, reason: reason })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(result.message);
                    loadBlacklist();
                } else {
                    alert('ì¶”ê°€ ì‹¤íŒ¨: ' + result.error);
                }
            })
            .catch(error => {
                alert('ì¶”ê°€ ì‹¤íŒ¨: ' + error.message);
            });
        }

        async function unblockIP(ip) {
            if (!confirm(`IP ${ip}ì˜ ì°¨ë‹¨ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            try {
                const response = await fetch(`/api/admin/blacklist/${ip}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('ì°¨ë‹¨ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadBlacklist();
                } else {
                    alert('ì°¨ë‹¨ í•´ì œ ì‹¤íŒ¨');
                }
            } catch (error) {
                alert('ì°¨ë‹¨ í•´ì œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        async function loadWhitelist() {
            try {
                const response = await fetch('/api/admin/whitelist');
                const whitelist = await response.json();
                
                const tbody = document.getElementById('whitelistTable');
                if (whitelist.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">ë“±ë¡ëœ IPê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                } else {
                    tbody.innerHTML = whitelist.map(item => `
                        <tr>
                            <td><code>${item.ip_address}</code></td>
                            <td>${item.description || 'ì„¤ëª… ì—†ìŒ'}</td>
                            <td>${new Date(item.created_at).toLocaleString()}</td>
                            <td>
                                ${item.is_default ? '<span style="color: #666; font-size: 12px;">ê¸°ë³¸ ì„¤ì •</span>' : `<button class="btn btn-small btn-danger" onclick="removeFromWhitelist('${item.ip_address}')">ì‚­ì œ</button>`}
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('whitelistTable').innerHTML = 
                    '<tr><td colspan="4" style="text-align: center; color: red;">í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨</td></tr>';
            }
        }

        document.getElementById('whitelistForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const ipData = {
                ip_address: document.getElementById('ipAddress').value,
                description: document.getElementById('description').value
            };

            try {
                const response = await fetch('/api/admin/whitelist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ipData)
                });

                if (response.ok) {
                    alert('IP ì£¼ì†Œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    document.getElementById('whitelistForm').reset();
                    loadWhitelist();
                } else {
                    const error = await response.json();
                    alert('IP ì¶”ê°€ ì‹¤íŒ¨: ' + error.error);
                }
            } catch (error) {
                alert('IP ì¶”ê°€ ì‹¤íŒ¨: ' + error.message);
            }
        });

        async function removeFromWhitelist(ip) {
            if (!confirm(`IP ${ip}ë¥¼ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            try {
                const response = await fetch(`/api/admin/whitelist/${encodeURIComponent(ip)}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('IPê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadWhitelist();
                } else {
                    alert('IP ì œê±° ì‹¤íŒ¨');
                }
            } catch (error) {
                alert('IP ì œê±° ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì¤‘ë³µ ì¼ê´„ ì •ë¦¬ ê¸°ëŠ¥
        async function cleanDuplicates() {
            if (!confirm('ì¤‘ë³µ íŒŒì¼ì„ ìë™ìœ¼ë¡œ ì •ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê°€ì¥ ì˜¤ë˜ëœ ê²ƒì„ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ ì‚­ì œ)')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/duplicates/clean', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    checkDuplicates(); // ë‹¤ì‹œ ê²€ì‚¬
                } else {
                    alert('ì •ë¦¬ ì‹¤íŒ¨: ' + data.error);
                }
            } catch (error) {
                alert('ì •ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì¤‘ë³µ ê²€ì‚¬ ê¸°ëŠ¥
        async function checkDuplicates() {
            document.getElementById('duplicatesLoading').style.display = 'block';
            document.getElementById('duplicatesSummary').style.display = 'none';
            
            try {
                const response = await fetch('/api/admin/duplicates/check');
                const data = await response.json();
                
                if (data.success) {
                    const summary = data.summary;
                    const infoHtml = `
                        <div class="row">
                            <div class="col-md-4"><strong>ì „ì²´ ë ˆì½”ë“œ:</strong> ${summary.total_records}ê°œ</div>
                            <div class="col-md-4"><strong>íŒŒì¼ëª… ì¤‘ë³µ:</strong> ${summary.filename_duplicates}ê°œ</div>
                            <div class="col-md-4"><strong>pending_file_id ì¤‘ë³µ:</strong> ${summary.pending_id_duplicates}ê°œ</div>
                        </div>
                        ${summary.filename_duplicates > 0 || summary.pending_id_duplicates > 0 ? 
                            '<div style="margin-top: 10px; color: #856404;"><strong>âš ï¸ ì¤‘ë³µ íŒŒì¼ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒì„¸ ê´€ë¦¬ í˜ì´ì§€ì—ì„œ ì œê±°í•˜ì„¸ìš”.</strong></div>' : 
                            '<div style="margin-top: 10px; color: #155724;"><strong>âœ… ì¤‘ë³µ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!</strong></div>'
                        }
                    `;
                    
                    document.getElementById('duplicatesInfo').innerHTML = infoHtml;
                    document.getElementById('duplicatesSummary').style.display = 'block';
                } else {
                    alert('ì˜¤ë¥˜: ' + data.error);
                }
            } catch (error) {
                alert('ê²€ì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                document.getElementById('duplicatesLoading').style.display = 'none';
            }
        }

        // ê²€ìƒ‰ ê¸°ëŠ¥
        function handleSearch(event) {
            if (event.key === 'Enter') {
                loadLabeledData();
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
        loadUsers();
    </script>
    
    <!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
    <a href="/logout" style="position: fixed; bottom: 20px; right: 20px; background: #e74c3c; color: white; padding: 10px 15px; border-radius: 50px; text-decoration: none; font-size: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 9999;">ğŸšº ë¡œê·¸ì•„ì›ƒ</a>
</body>
</html>