<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>NEST ê³¤ì¶©ìƒíƒœì§€ë„</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='animations.css') }}">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Pretendard Variable", "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
      background: #FFFFFF;
      color: #1F2937;
      line-height: 1.6;
      padding-bottom: 80px; /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ê³µê°„ */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ìƒë‹¨ í—¤ë” - ìœ„ì¹˜ ì„ íƒ */
    .top-header {
      background: linear-gradient(135deg, #3182F6 0%, #4285F4 100%);
      padding: 12px 16px;
      color: white;
      display: flex;
      align-items: center;
      gap: 8px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .app-title {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }

    .app-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: linear-gradient(135deg, #34A8C7 0%, #8BC34A 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .app-title-text {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    /* ì •ë³´ ë°°ë„ˆ */
    .info-banner {
      background: #F3F4F6;
      border-radius: 12px;
      padding: 12px 16px;
      margin: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
    }

    .info-banner.hidden {
      display: none;
    }

    .info-text {
      font-size: 13px;
      color: #4B5563;
      line-height: 1.5;
      flex: 1;
      padding-right: 8px;
    }

    .info-close {
      background: none;
      border: none;
      font-size: 18px;
      color: #6B7280;
      cursor: pointer;
      padding: 4px;
      line-height: 1;
    }


    /* ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ (íƒì§€/ë¶„ë¥˜ ê²°ê³¼) */
    .main-content {
      margin: 0;
      padding: 0 16px;
      max-width: 100%;
    }
    
    .content-card {
      max-width: 100%;
      margin: 0;
    }

    .content-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .upload-area {
      border: 2px dashed #3182F6;
      border-radius: 16px;
      padding: 60px 20px;
      text-align: center;
      background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%);
      min-height: 300px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .upload-area:hover {
      background: linear-gradient(135deg, #E8F0FE 0%, #DBEAFE 100%);
      border-color: #4285F4;
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(49, 130, 246, 0.15);
    }

    .upload-area.has-image {
      padding: 0;
      border: 2px solid #3182F6;
      background: white;
      min-height: auto;
    }

    #uploadPlaceholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
    }

    .upload-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #3182F6 0%, #4285F4 100%);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      margin: 0 auto 20px;
      font-size: 40px;
      box-shadow: 0 4px 12px rgba(49, 130, 246, 0.3);
      transition: transform 0.3s ease;
    }

    .upload-area:hover .upload-icon {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 6px 16px rgba(49, 130, 246, 0.4);
    }

    .upload-text {
      color: #6B7280;
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .image-container {
      position: relative;
      display: inline-block;
      width: 100%;
      max-width: 100%;
    }

    .image-container img {
      max-width: 100%;
      height: auto;
      display: block;
      border-radius: 8px;
    }

    .canvas-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: crosshair;
    }

    .bbox {
      position: absolute;
      border: 2.5px solid #3182F6;
      background: rgba(49, 130, 246, 0.1);
      cursor: move;
      border-radius: 4px;
      transition: all 0.2s ease;
      touch-action: none;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-user-select: none;
    }

    .bbox.selected {
      border-color: #EF4444;
      background: rgba(239, 68, 68, 0.15);
      z-index: 10;
      box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
    }

    .bbox-label {
      position: absolute;
      top: -24px;
      left: 0;
      background: linear-gradient(135deg, #3182F6 0%, #4285F4 100%);
      color: white;
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 600;
      border-radius: 6px;
      pointer-events: none;
    }

    .resize-handle {
      position: absolute;
      width: 16px;
      height: 16px;
      background: #3182F6;
      border: 2.5px solid white;
      border-radius: 50%;
      cursor: nwse-resize;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      touch-action: none;
      -webkit-tap-highlight-color: transparent;
    }

    .resize-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
    .resize-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
    .resize-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
    .resize-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }

    .bbox.selected .resize-handle {
      background: #EF4444;
    }

    /* ê²°ê³¼ í‘œì‹œ */
    .detection-info {
      background: linear-gradient(135deg, #E8F0FE 0%, #DBEAFE 100%);
      border: 1.5px solid #3182F6;
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }

    .detection-count {
      font-size: 16px;
      font-weight: 700;
      color: #3182F6;
      margin-bottom: 12px;
    }

    .detection-item {
      padding: 12px;
      background: white;
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 13px;
    }

    .btn {
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      margin-top: 12px;
      text-align: center;
    }
    
    .btn span {
      text-align: center;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3182F6 0%, #4285F4 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(49, 130, 246, 0.3);
    }

    .btn-primary:active {
      transform: scale(0.98);
    }

    .btn-secondary {
      background-color: white;
      color: #374151;
      border: 1.5px solid #E5E7EB;
    }

    /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #E5E7EB;
      padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
      z-index: 9999;
      display: flex;
      justify-content: space-around;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.06);
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px 24px;
      color: #6B7280;
      font-size: 11px;
      transition: color 0.2s ease;
    }

    .nav-item.active {
      color: #3182F6;
    }

    .nav-icon {
      font-size: 24px;
    }

    /* í”Œë¡œíŒ… ì•¡ì…˜ ë²„íŠ¼ */
    .fab {
      position: fixed;
      bottom: 90px;
      right: 16px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3182F6 0%, #4285F4 100%);
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(49, 130, 246, 0.4);
      z-index: 99;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease;
    }

    .fab:active {
      transform: scale(0.95);
    }

    /* Flash Messages */
    .flash {
      background: #f0f0f0;
      padding: 12px 16px;
      margin: 16px;
      border-radius: 8px;
      color: #333;
      font-size: 14px;
    }

    .flash.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .flash.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* ìˆ¨ê¹€ ì²˜ë¦¬ */
    #imageInput {
      display: none;
    }

    /* ì—…ë¡œë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .upload-btn {
      width: 100%;
      padding: 20px;
      border-radius: 16px;
      border: none;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
    }

    .upload-btn:active {
      transform: scale(0.98);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.12);
    }

    .camera-btn {
      background: linear-gradient(135deg, #3182F6 0%, #4285F4 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(49, 130, 246, 0.3);
    }

    .camera-btn:active {
      box-shadow: 0 2px 8px rgba(49, 130, 246, 0.4);
    }

    .gallery-btn {
      background: white;
      color: #1F2937;
      border: 2px solid #E5E7EB;
    }

    .gallery-btn:active {
      background: #F9FAFB;
    }

    .upload-btn-icon {
      font-size: 32px;
      flex-shrink: 0;
    }

    .upload-btn-text {
      flex: 1;
    }

    /* ë¡œë”© ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
    .loading-spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .loading-spinner-overlay.active {
      display: flex;
    }

    .loading-spinner-content {
      background: white;
      border-radius: 20px;
      padding: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      animation: fadeInScale 0.3s ease-out;
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid #E5E7EB;
      border-top: 4px solid #3182F6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      font-weight: 600;
      color: #1F2937;
      text-align: center;
    }

    .loading-subtext {
      font-size: 13px;
      color: #6B7280;
      text-align: center;
      max-width: 250px;
    }

    /* ë°ìŠ¤í¬í†± ëŒ€ì‘ */
    @media (min-width: 768px) {
      body {
        max-width: 768px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <!-- ìƒë‹¨ í—¤ë” -->
  <div class="top-header">
    <div class="app-title">
      <div class="app-icon">ğŸ›</div>
      <span class="app-title-text">NEST</span>
    </div>
  </div>

  <!-- ì •ë³´ ë°°ë„ˆ -->
  <div class="info-banner" id="infoBanner">
    <div class="info-text">ì§€ì—­ì„ ì„ íƒí•˜ë©´ ì§€ì—­ë³„ í•´ì¶© ê²½ë³´ ë° í˜„ì¥ ê°€ì´ë“œë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    <button class="info-close" onclick="closeBanner()">Ã—</button>
  </div>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      {% for msg in messages %}
        <div class="flash {% if 'ì™„ë£Œ' in msg or 'ì„±ê³µ' in msg %}success{% elif 'ì˜¤ë¥˜' in msg or 'ì‹¤íŒ¨' in msg %}error{% endif %}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- ë©”ì¸ ì½˜í…ì¸  -->
  <div class="main-content">
    <div class="content-card">
      {% if detection %}
        <div style="margin-bottom: 16px;">
          <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px;">{% if detection.detailed_info %}ë¶„ì„ ì™„ë£Œ{% elif detection.risk_assessment %}ìœ„í—˜ë„ í‰ê°€ ì™„ë£Œ{% elif detection.classifications %}ë¶„ë¥˜ ì™„ë£Œ{% else %}íƒì§€ ê²°ê³¼{% endif %}</h3>
        </div>
        
        <div class="upload-area has-image">
          <div class="image-container" id="imageContainer">
            <img id="originalImage" src="{{ url_for('uploaded_file', filename=detection.original_image) }}" alt="Original Image" />
            {% if detection and not detection.classifications %}
            <div id="bboxContainer" class="canvas-overlay"></div>
            {% endif %}
          </div>
        </div>

        {% if detection and not detection.classifications %}
        <div id="bboxControls" style="margin-top: 12px; display: flex; gap: 8px;">
          <button type="button" class="btn btn-secondary" onclick="saveBoundingBoxes()" style="flex: 1; margin: 0;">ì €ì¥</button>
          <button type="button" class="btn btn-secondary" onclick="resetBoundingBoxes()" style="flex: 1; margin: 0;">ì´ˆê¸°í™”</button>
        </div>
        {% endif %}

        <div class="detection-info" style="text-align: center; margin: 0 -16px; padding: 0 16px;">
          {% if detection.detailed_info %}
            {% for info in detection.detailed_info %}
              {% set cls_result = detection.classifications[loop.index0] if detection.classifications and loop.index0 < detection.classifications|length else none %}
              {% set insect_idx = loop.index0 %}
              {% if cls_result and cls_result.hierarchical_result and cls_result.hierarchical_result.species_candidates and cls_result.hierarchical_result.species_candidates|length > 1 %}
                <div style="margin: 12px 0; padding: 12px; background: white; border-radius: 8px;">
                  <div style="color: #495057; font-size: 12px; margin-bottom: 8px; font-weight: 600; text-align: center;">ì¢… í›„ë³´ ì„ íƒ:</div>
                  <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                  {% for candidate in cls_result.hierarchical_result.species_candidates[:3] %}
                    {% set is_selected = (cls_result.hierarchical_result.selected_species == candidate.name) if cls_result.hierarchical_result.get('selected_species') else (loop.index == 1) %}
                    <div onclick="selectCandidateTab({{ insect_idx }}, '{{ candidate.name }}', this)" class="candidate-tab" data-insect-index="{{ insect_idx }}" data-species="{{ candidate.name }}" style="flex: 1; min-width: 100px; padding: 8px 12px; background: {% if is_selected %}#3182F6{% else %}white{% endif %}; color: {% if is_selected %}white{% else %}#1F2937{% endif %}; border-radius: 8px; border: 2px solid {% if is_selected %}#3182F6{% else %}#E5E7EB{% endif %}; cursor: pointer; text-align: center; font-size: 12px;">
                      <div style="font-weight: {% if is_selected %}600{% else %}500{% endif %}; margin-bottom: 2px;">{{ candidate.name }}</div>
                      <div style="font-size: 10px; opacity: 0.8;">{{ "%.1f"|format(candidate.confidence * 100) }}%</div>
                    </div>
                  {% endfor %}
                  </div>
                </div>
              {% endif %}
            {% endfor %}
            
            <div style="margin-top: 12px;">
              {% for info in detection.detailed_info %}
                <div class="detection-item" style="padding: 24px; background: white; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-left: -16px; margin-right: -16px; padding-left: 20px; padding-right: 20px; border: 1px solid #E5E7EB;">
                  <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 8px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 3px solid #3182F6;">
                    <strong style="color: #1F2937; font-size: 24px; font-weight: 800; letter-spacing: -0.5px; line-height: 1.3; width: 100%; text-align: left;">{{ info.korean_name or info.species_name }}</strong>
                    {% if info.scientific_name %}
                    <span style="color: #6B7280; font-size: 15px; font-style: italic; letter-spacing: -0.2px; font-weight: 500; width: 100%; text-align: left;">{{ info.scientific_name }}</span>
                    {% endif %}
                  </div>
                  
                  {% if info.risk_assessment and (info.risk_assessment.threat_level or info.risk_assessment.risk_category or info.risk_assessment.human_risks) %}
                  <div style="margin-top: 20px; padding: 24px; background: {% if info.risk_assessment.threat_level == 'ì¸ì²´ ê³ ìœ„í—˜(ê³µê²©ì„±Â·ë…ì„±)' %}#FEE2E2{% elif info.risk_assessment.threat_level == 'ì¸ì²´ ì¤‘ìœ„í—˜(ë…ì„±Â·í”¼ë¶€ì—¼Â·ì§ˆë³‘ ë§¤ê°œ)' %}#FEF3C7{% else %}#F3F4F6{% endif %}; border-radius: 16px; border: 2px solid {% if info.risk_assessment.threat_level == 'ì¸ì²´ ê³ ìœ„í—˜(ê³µê²©ì„±Â·ë…ì„±)' %}#FCA5A5{% elif info.risk_assessment.threat_level == 'ì¸ì²´ ì¤‘ìœ„í—˜(ë…ì„±Â·í”¼ë¶€ì—¼Â·ì§ˆë³‘ ë§¤ê°œ)' %}#FCD34D{% else %}#D1D5DB{% endif %}; border-left: 6px solid {% if info.risk_assessment.threat_level == 'ì¸ì²´ ê³ ìœ„í—˜(ê³µê²©ì„±Â·ë…ì„±)' %}#DC2626{% elif info.risk_assessment.threat_level == 'ì¸ì²´ ì¤‘ìœ„í—˜(ë…ì„±Â·í”¼ë¶€ì–¼Â·ì§ˆë³‘ ë§¤ê°œ)' %}#F59E0B{% else %}#6B7280{% endif %};">
                    <div style="font-weight: 700; color: #1F2937; font-size: 17px; margin-bottom: 16px; text-align: left; letter-spacing: -0.3px; display: flex; align-items: center; gap: 8px;">
                      <span style="font-size: 24px;">âš ï¸</span>
                      <span>ìœ„í—˜ë„ í‰ê°€</span>
                    </div>
                    {% if info.risk_assessment.threat_level %}
                    <div style="margin-bottom: 16px; display: flex; justify-content: flex-start; width: 100%;">
                      <span style="background: {% if info.risk_assessment.threat_level == 'ì¸ì²´ ê³ ìœ„í—˜(ê³µê²©ì„±Â·ë…ì„±)' %}#DC2626{% elif info.risk_assessment.threat_level == 'ì¸ì²´ ì¤‘ìœ„í—˜(ë…ì„±Â·í”¼ë¶€ì—¼Â·ì§ˆë³‘ ë§¤ê°œ)' %}#F59E0B{% else %}#6B7280{% endif %}; color: white; padding: 10px 20px; border-radius: 12px; font-size: 15px; font-weight: 700; letter-spacing: -0.2px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); width: 100%; text-align: center;">{{ info.risk_assessment.threat_level }}</span>
                    </div>
                    {% endif %}
                    {% if info.risk_assessment.risk_category %}
                    <div style="font-size: 15px; color: #374151; margin-bottom: 12px; text-align: left; letter-spacing: -0.2px; line-height: 1.6; padding: 12px; background: white; border-radius: 8px;">
                      <strong style="font-weight: 700;">ë¶„ë¥˜:</strong> {{ info.risk_assessment.risk_category }}
                    </div>
                    {% endif %}
                    {% if info.risk_assessment.human_risks %}
                    <div style="font-size: 15px; color: #374151; text-align: left; letter-spacing: -0.2px; line-height: 1.8;">
                      {% if info.risk_assessment.human_risks.venom_toxicity %}
                      <div style="margin-bottom: 12px; padding: 12px; background: white; border-radius: 8px;">
                        <strong style="font-weight: 700;">ë…ì„±:</strong> {{ info.risk_assessment.human_risks.venom_toxicity }}
                      </div>
                      {% endif %}
                      {% if info.risk_assessment.human_risks.symptoms %}
                      <div style="margin-bottom: 12px; padding: 12px; background: white; border-radius: 8px;">
                        <strong style="font-weight: 700; display: block; margin-bottom: 8px;">ì¦ìƒ:</strong>
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.9;">
                          {% for symptom in info.risk_assessment.human_risks.symptoms %}
                          <li style="margin-bottom: 6px;">{{ symptom }}</li>
                          {% endfor %}
                        </ul>
                      </div>
                      {% endif %}
                      {% if info.risk_assessment.human_risks.behavior %}
                      <div style="padding: 12px; background: white; border-radius: 8px;">
                        <strong style="font-weight: 700;">í–‰ë™:</strong> {{ info.risk_assessment.human_risks.behavior }}
                      </div>
                      {% endif %}
                    </div>
                    {% endif %}
                  </div>
                  {% endif %}
                  
                  {% if info.first_aid and (info.first_aid.immediate_actions or info.first_aid.emergency_signs or info.first_aid.when_to_seek_help) %}
                  <div style="margin-top: 20px; padding: 24px; background: #FEF3C7; border-radius: 16px; border: 2px solid #FDE68A; border-left: 6px solid #F59E0B; text-align: left;">
                    <div style="font-weight: 700; color: #1F2937; font-size: 17px; margin-bottom: 16px; text-align: left; letter-spacing: -0.3px; display: flex; align-items: center; gap: 8px;">
                      <span style="font-size: 24px;">ğŸš‘</span>
                      <span>ì‘ê¸‰ ì²˜ì¹˜</span>
                    </div>
                    {% if info.first_aid.immediate_actions %}
                    <div style="margin-bottom: 16px; text-align: left; padding: 16px; background: white; border-radius: 12px;">
                      <div style="font-weight: 700; font-size: 15px; color: #92400E; margin-bottom: 12px; letter-spacing: -0.2px; text-align: left;">ì¦‰ì‹œ ì¡°ì¹˜:</div>
                      <ul style="margin: 0; padding-left: 20px; font-size: 15px; color: #374151; line-height: 1.9; letter-spacing: -0.2px; text-align: left;">
                        {% for action in info.first_aid.immediate_actions %}
                        <li style="margin-bottom: 8px; text-align: left;">{{ action }}</li>
                        {% endfor %}
                      </ul>
                    </div>
                    {% endif %}
                    {% if info.first_aid.emergency_signs %}
                    <div style="margin-bottom: 16px; text-align: left; padding: 16px; background: white; border-radius: 12px;">
                      <div style="font-weight: 700; font-size: 15px; color: #DC2626; margin-bottom: 12px; letter-spacing: -0.2px; text-align: left;">ì‘ê¸‰ ì¦ìƒ:</div>
                      <ul style="margin: 0; padding-left: 20px; font-size: 15px; color: #374151; line-height: 1.9; letter-spacing: -0.2px; text-align: left;">
                        {% for sign in info.first_aid.emergency_signs %}
                        <li style="margin-bottom: 8px; text-align: left;">{{ sign }}</li>
                        {% endfor %}
                      </ul>
                    </div>
                    {% endif %}
                    {% if info.first_aid.when_to_seek_help %}
                    <div style="font-size: 15px; color: #DC2626; font-weight: 700; letter-spacing: -0.2px; line-height: 1.8; text-align: left; padding: 16px; background: white; border-radius: 12px;">{{ info.first_aid.when_to_seek_help }}</div>
                    {% endif %}
                  </div>
                  {% endif %}
                  
                  {% if info.prevention_measures and info.prevention_measures|length > 0 %}
                  <div style="margin-top: 20px; padding: 24px; background: #F0F9FF; border-radius: 16px; border: 2px solid #BFDBFE; border-left: 6px solid #3B82F6; text-align: left;">
                    <div style="font-weight: 700; color: #1F2937; font-size: 17px; margin-bottom: 16px; text-align: left; letter-spacing: -0.3px; display: flex; align-items: center; gap: 8px;">
                      <span style="font-size: 24px;">ğŸ›¡ï¸</span>
                      <span>ì˜ˆë°© ì¡°ì¹˜</span>
                    </div>
                    <ul style="margin: 0; padding-left: 20px; font-size: 15px; color: #374151; line-height: 1.9; letter-spacing: -0.2px; text-align: left;">
                      {% for measure in info.prevention_measures %}
                      <li style="margin-bottom: 8px; text-align: left;">{{ measure }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% elif detection.risk_assessment %}
            <div style="margin-top: 12px;">
              {% for risk in detection.risk_assessment %}
                {% if risk %}
                <div class="detection-item">
                  <strong>{{ risk.species_name if risk.species_name else 'ë¯¸ìƒ' }}</strong><br>
                  <div style="margin-top: 8px;">
                    {% set threat_level = risk.threat_level if risk.threat_level else '' %}
                    {% if threat_level %}
                      {% if 'ì¸ì²´ ê³ ìœ„í—˜' in threat_level or 'ê³µê²©ì„±Â·ë…ì„±' in threat_level %}
                        <span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">ë§¤ìš° ìœ„í—˜</span>
                      {% elif 'ì¸ì²´ ì¤‘ìœ„í—˜' in threat_level or 'ë…ì„±Â·í”¼ë¶€ì—¼' in threat_level or 'ì§ˆë³‘ ë§¤ê°œ' in threat_level %}
                        <span style="background: #fd7e14; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">ìœ„í—˜</span>
                      {% elif 'ë°˜ë ¤ë™ë¬¼ ìœ„í—˜' in threat_level %}
                        <span style="background: #ffc107; color: #333; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">ë³´í†µ</span>
                      {% elif 'ì¼ë°˜Â·ë¶ˆì¾Œ' in threat_level or 'ë¶ˆì¾Œ ê³¤ì¶©' in threat_level %}
                        <span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">ì•ˆì „</span>
                      {% elif threat_level == 'ë¯¸ë¶„ë¥˜' %}
                        <span style="background: #1E40AF; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">ë¯¸ë¶„ë¥˜</span>
                      {% else %}
                        <span style="background: #6c757d; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">ë¯¸ë¶„ë¥˜</span>
                      {% endif %}
                    {% else %}
                      <span style="background: #1E40AF; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">ë¯¸ë¶„ë¥˜</span>
                    {% endif %}
                    <span style="margin-left: 8px; color: #666; font-size: 12px;">{{ risk.description if risk.description else 'ì„¤ëª… ì—†ìŒ' }}</span>
                  </div>
                </div>
                {% endif %}
              {% endfor %}
            </div>
          {% elif detection.classifications %}
            <div style="margin-top: 12px;">
              {% for cls_result in detection.classifications %}
                {% if cls_result %}
                <div class="detection-item">
                  {% if cls_result.hierarchical_result %}
                    {% if cls_result.hierarchical_result.order %}
                      <div style="margin-top: 8px; font-size: 12px;">
                        <span style="color: #666;">ëª©:</span>
                        <span style="color: #3182F6; margin-left: 4px; font-weight: 600;">{{ cls_result.hierarchical_result.order }}</span>
                      </div>
                    {% endif %}
                    {% if cls_result.hierarchical_result.family %}
                      <div style="margin-top: 4px; font-size: 12px; padding-left: 10px;">
                        <span style="color: #666;">ê³¼:</span>
                        <span style="color: #3182F6; margin-left: 4px; font-weight: 600;">{{ cls_result.hierarchical_result.family }}</span>
                      </div>
                    {% endif %}
                    {% if cls_result.hierarchical_result.species %}
                      <div style="margin-top: 4px; font-size: 12px; padding-left: 20px;">
                        <span style="color: #666;">ì¢…:</span>
                        <span style="color: #3182F6; margin-left: 4px; font-weight: 600;">{{ cls_result.hierarchical_result.species }}</span>
                      </div>
                    {% endif %}
                  {% endif %}
                </div>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}

          {% if detection and not detection.classifications and detection.count > 0 %}
          <button type="button" class="btn btn-primary" onclick="proceedToClassification()" id="classifyBtn">
            <span>âœ“</span>
            <span>ë¶„ë¥˜í•˜ê¸°</span>
          </button>
          <p style="font-size: 11px; color: #666; margin-top: 8px; text-align: center;">ë¹¨ê°„ìƒ‰ ë°•ìŠ¤ë¥¼ í´ë¦­í•˜ì—¬ ì„ íƒ (Ctrl/Cmd+í´ë¦­ìœ¼ë¡œ ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥)</p>
          {% endif %}

          {% if detection.detailed_info %}
          <button type="button" class="btn btn-primary" onclick="window.location.href='{{ url_for('reset_session') }}'">
            <span>ğŸ”„</span>
            <span>ìƒˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ</span>
          </button>
          {% endif %}
        </div>
      {% else %}
        <div style="text-align: center; margin-bottom: 24px;">
          <h2 style="font-size: 20px; font-weight: 700; color: #1F2937; margin-bottom: 8px;">ê³¤ì¶© ì‹ë³„í•˜ê¸°</h2>
          <p style="font-size: 14px; color: #6B7280;">ê³¤ì¶© ì‚¬ì§„ì„ ì´¬ì˜í•˜ê±°ë‚˜ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</p>
        </div>
        
        <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
        <div id="previewContainer" style="display: none; margin-bottom: 20px;">
          <img id="previewImage" style="width: 100%; height: auto; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" alt="Preview" />
        </div>
        
        <!-- ì¹´ë©”ë¼ ì´¬ì˜ ë° ê°¤ëŸ¬ë¦¬ ë²„íŠ¼ -->
        <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
          <button type="button" class="upload-btn camera-btn" onclick="openCamera()">
            <div class="upload-btn-icon">ğŸ“·</div>
            <div class="upload-btn-text">
              <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">ì¹´ë©”ë¼ë¡œ ì´¬ì˜í•˜ê¸°</div>
              <div style="font-size: 12px; opacity: 0.7;">ì‹¤ì‹œê°„ìœ¼ë¡œ ê³¤ì¶© ì‚¬ì§„ ì´¬ì˜</div>
            </div>
          </button>
          
          <button type="button" class="upload-btn gallery-btn" onclick="openGallery()">
            <div class="upload-btn-icon">ğŸ–¼ï¸</div>
            <div class="upload-btn-text">
              <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">ê°¤ëŸ¬ë¦¬ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</div>
              <div style="font-size: 12px; opacity: 0.7;">ì €ì¥ëœ ì‚¬ì§„ì—ì„œ ì„ íƒ</div>
            </div>
          </button>
        </div>
        
        <form method="post" enctype="multipart/form-data" id="uploadForm">
          <input type="file"
                 id="imageInput"
                 name="photo"
                 accept="image/*" />
        </form>
      {% endif %}
    </div>
  </div>


  <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ ì˜¤ë²„ë ˆì´ -->
  <div id="loadingSpinner" class="loading-spinner-overlay">
    <div class="loading-spinner-content">
      <div class="spinner"></div>
      <div class="loading-text" id="loadingText">ë¶„ë¥˜ ì¤‘...</div>
      <div class="loading-subtext" id="loadingSubtext">AIê°€ ê³¤ì¶©ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
    </div>
  </div>

  <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <div class="bottom-nav">
    <a href="{{ url_for('board_page') }}" class="nav-item">
      <div class="nav-icon">ğŸ“‹</div>
      <div>ê²Œì‹œíŒ</div>
    </a>
    <a href="{{ url_for('index') }}" class="nav-item active">
      <div class="nav-icon">ğŸ“·</div>
      <div>ì´¬ì˜</div>
    </a>
    <a href="{{ url_for('map_page') }}" class="nav-item">
      <div class="nav-icon">ğŸ—ºï¸</div>
      <div>ì§€ë„</div>
    </a>
  </div>

  <script src="{{ url_for('static', filename='app.js') }}"></script>
  <script>
    const imageInput = document.getElementById('imageInput');
    const previewImage = document.getElementById('previewImage');
    const previewContainer = document.getElementById('previewContainer');
    const uploadForm = document.getElementById('uploadForm');
    
    // ì¤‘ë³µ í´ë¦­ ë°©ì§€ í”Œë˜ê·¸
    let isUploading = false;

    if (imageInput) {
      imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          // íŒŒì¼ í¬ê¸° ê²€ì¦
          if (file.size > 16 * 1024 * 1024) {
            alert('íŒŒì¼ í¬ê¸°ëŠ” 16MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            imageInput.value = ''; // ì…ë ¥ ì´ˆê¸°í™”
            isUploading = false;
            return;
          }

          // íŒŒì¼ íƒ€ì… ê²€ì¦
          if (!file.type.startsWith('image/')) {
            alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            imageInput.value = '';
            isUploading = false;
            return;
          }

          // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
          const reader = new FileReader();
          reader.onload = function(e) {
            if (previewImage) {
              previewImage.src = e.target.result;
            }
            if (previewContainer) {
              previewContainer.style.display = 'block';
            }
          };
          reader.readAsDataURL(file);

          // í¼ ì œì¶œ
          if (uploadForm) {
            // ì¤‘ë³µ ì œì¶œ ë°©ì§€ë¥¼ ìœ„í•œ request_id ì¶”ê°€
            const requestId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'request_id';
            hiddenInput.value = requestId;
            uploadForm.appendChild(hiddenInput);
            
            uploadForm.submit();
          }
        }
        isUploading = false;
      });
    }

    // Interactive Bounding Box Management
    {% if detection and not detection.classifications %}
    let boundingBoxes = [];
    let selectedBboxes = []; // ì—¬ëŸ¬ ê°œ ì„ íƒì„ ìœ„í•œ ë°°ì—´ë¡œ ë³€ê²½
    let isDragging = false;
    let isResizing = false;
    let resizeHandle = null;
    let dragOffset = { x: 0, y: 0 };
    let originalBboxes = {{ detection.detections | tojson }};

    const imageContainer = document.getElementById('imageContainer');
    const originalImage = document.getElementById('originalImage');
    const bboxContainer = document.getElementById('bboxContainer');

    originalImage.addEventListener('load', function() {
      initializeBoundingBoxes();
    });

    if (originalImage.complete) {
      initializeBoundingBoxes();
    }
    
    updateClassifyButton();

    function initializeBoundingBoxes() {
      const img = originalImage;
      const imgRect = img.getBoundingClientRect();
      const scaleX = imgRect.width / img.naturalWidth;
      const scaleY = imgRect.height / img.naturalHeight;

      bboxContainer.innerHTML = '';
      boundingBoxes = [];

      // ëª¨ë“  ë°”ìš´ë”© ë°•ìŠ¤ í‘œì‹œ
      originalBboxes.forEach((det, index) => {
        const bbox = det.bbox;
        const x1 = bbox[0] * scaleX;
        const y1 = bbox[1] * scaleY;
        const x2 = bbox[2] * scaleX;
        const y2 = bbox[3] * scaleY;

        createBoundingBox(x1, y1, x2, y2, index, det.confidence);
      });
      
      // ì²« ë²ˆì§¸ ë°•ìŠ¤ ìë™ ì„ íƒ
      if (boundingBoxes.length > 0) {
        selectBbox(boundingBoxes[0].element, false);
      }
    }

    function createBoundingBox(x1, y1, x2, y2, index, confidence) {
      const bbox = document.createElement('div');
      bbox.className = 'bbox';
      bbox.dataset.index = index;
      
      const left = Math.min(x1, x2);
      const top = Math.min(y1, y2);
      const width = Math.abs(x2 - x1);
      const height = Math.abs(y2 - y1);

      bbox.style.left = left + 'px';
      bbox.style.top = top + 'px';
      bbox.style.width = width + 'px';
      bbox.style.height = height + 'px';

      // ë¼ë²¨ ì¶”ê°€
      const label = document.createElement('div');
      label.className = 'bbox-label';
      label.textContent = `#${index + 1}`;
      bbox.appendChild(label);

      ['nw', 'ne', 'sw', 'se'].forEach(pos => {
        const handle = document.createElement('div');
        handle.className = `resize-handle ${pos}`;
        bbox.appendChild(handle);
      });

      // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
      bbox.addEventListener('mousedown', function(e) {
        if (e.target.classList.contains('resize-handle')) {
          return;
        }
        // Ctrl/Cmd í‚¤ë¥¼ ëˆ„ë¥´ê³  ìˆìœ¼ë©´ ë‹¤ì¤‘ ì„ íƒ, ì•„ë‹ˆë©´ ë‹¨ì¼ ì„ íƒ
        const isMultiSelect = e.ctrlKey || e.metaKey;
        selectBbox(bbox, isMultiSelect);
        currentDraggingBbox = bbox; // í˜„ì¬ ë“œë˜ê·¸ ì¤‘ì¸ ë°•ìŠ¤ ì €ì¥
        isDragging = true;
        const rect = bbox.getBoundingClientRect();
        dragOffset.x = e.clientX - rect.left;
        dragOffset.y = e.clientY - rect.top;
        e.preventDefault();
      });

      // í„°ì¹˜ ì´ë²¤íŠ¸ ì¶”ê°€
      let touchStartX = 0;
      let touchStartY = 0;
      let touchStartBboxLeft = 0;
      let touchStartBboxTop = 0;
      let touchStartBboxWidth = 0;
      let touchStartBboxHeight = 0;
      let touchResizeHandle = null;

      bbox.addEventListener('touchstart', function(e) {
        if (e.target.classList.contains('resize-handle')) {
          touchResizeHandle = e.target.className.split(' ')[1];
          selectBbox(bbox, false);
          isResizing = true;
          const rect = bbox.getBoundingClientRect();
          const containerRect = imageContainer.getBoundingClientRect();
          touchStartX = e.touches[0].clientX - containerRect.left;
          touchStartY = e.touches[0].clientY - containerRect.top;
          touchStartBboxLeft = parseFloat(bbox.style.left);
          touchStartBboxTop = parseFloat(bbox.style.top);
          touchStartBboxWidth = parseFloat(bbox.style.width);
          touchStartBboxHeight = parseFloat(bbox.style.height);
          e.preventDefault();
          e.stopPropagation();
        } else {
          selectBbox(bbox, false);
          currentDraggingBbox = bbox;
          isDragging = true;
          const rect = bbox.getBoundingClientRect();
          const containerRect = imageContainer.getBoundingClientRect();
          touchStartX = e.touches[0].clientX - containerRect.left;
          touchStartY = e.touches[0].clientY - containerRect.top;
          touchStartBboxLeft = parseFloat(bbox.style.left);
          touchStartBboxTop = parseFloat(bbox.style.top);
          e.preventDefault();
          e.stopPropagation();
        }
      }, { passive: false });

      bbox.addEventListener('touchmove', function(e) {
        if (!isDragging && !isResizing) return;
        
        const containerRect = imageContainer.getBoundingClientRect();
        const touchX = e.touches[0].clientX - containerRect.left;
        const touchY = e.touches[0].clientY - containerRect.top;
        const deltaX = touchX - touchStartX;
        const deltaY = touchY - touchStartY;

        if (isResizing && touchResizeHandle) {
          const img = originalImage;
          const imgRect = img.getBoundingClientRect();
          let newLeft = touchStartBboxLeft;
          let newTop = touchStartBboxTop;
          let newWidth = touchStartBboxWidth;
          let newHeight = touchStartBboxHeight;

          if (touchResizeHandle.includes('w')) {
            const diff = deltaX;
            newLeft = Math.max(0, touchStartBboxLeft + diff);
            newWidth = Math.max(20, touchStartBboxWidth - diff);
          }
          if (touchResizeHandle.includes('e')) {
            newWidth = Math.max(20, touchStartBboxWidth + deltaX);
          }
          if (touchResizeHandle.includes('n')) {
            const diff = deltaY;
            newTop = Math.max(0, touchStartBboxTop + diff);
            newHeight = Math.max(20, touchStartBboxHeight - diff);
          }
          if (touchResizeHandle.includes('s')) {
            newHeight = Math.max(20, touchStartBboxHeight + deltaY);
          }

          if (newLeft + newWidth > imgRect.width) {
            newWidth = imgRect.width - newLeft;
          }
          if (newTop + newHeight > imgRect.height) {
            newHeight = imgRect.height - newTop;
          }

          bbox.style.left = newLeft + 'px';
          bbox.style.top = newTop + 'px';
          bbox.style.width = newWidth + 'px';
          bbox.style.height = newHeight + 'px';
        } else if (isDragging) {
          const img = originalImage;
          const imgRect = img.getBoundingClientRect();
          const maxX = imgRect.width - parseFloat(bbox.style.width);
          const maxY = imgRect.height - parseFloat(bbox.style.height);
          
          const newLeft = Math.max(0, Math.min(touchStartBboxLeft + deltaX, maxX));
          const newTop = Math.max(0, Math.min(touchStartBboxTop + deltaY, maxY));
          
          bbox.style.left = newLeft + 'px';
          bbox.style.top = newTop + 'px';
        }
        
        e.preventDefault();
        e.stopPropagation();
      }, { passive: false });

      bbox.addEventListener('touchend', function(e) {
        isDragging = false;
        isResizing = false;
        touchResizeHandle = null;
        currentDraggingBbox = null;
        e.preventDefault();
        e.stopPropagation();
      }, { passive: false });

      bbox.querySelectorAll('.resize-handle').forEach(handle => {
        handle.addEventListener('mousedown', function(e) {
          const isMultiSelect = e.ctrlKey || e.metaKey;
          selectBbox(bbox, isMultiSelect);
          isResizing = true;
          resizeHandle = handle.className.split(' ')[1];
          e.stopPropagation();
          e.preventDefault();
        });
        
        // í„°ì¹˜ ì´ë²¤íŠ¸ëŠ” bbox ë ˆë²¨ì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì¶”ê°€í•˜ì§€ ì•ŠìŒ
      });

      bboxContainer.appendChild(bbox);
      boundingBoxes.push({
        element: bbox,
        index: index,
        original: originalBboxes[index]
      });
    }

    function selectBbox(bbox, multiSelect = false) {
      if (multiSelect) {
        // ë‹¤ì¤‘ ì„ íƒ ëª¨ë“œ: ì´ë¯¸ ì„ íƒëœ ê²½ìš° ì œê±°, ì•„ë‹ˆë©´ ì¶”ê°€
        if (bbox.classList.contains('selected')) {
          bbox.classList.remove('selected');
          selectedBboxes = selectedBboxes.filter(b => b !== bbox);
        } else {
          bbox.classList.add('selected');
          selectedBboxes.push(bbox);
        }
      } else {
        // ë‹¨ì¼ ì„ íƒ ëª¨ë“œ: ê¸°ì¡´ ì„ íƒ ëª¨ë‘ í•´ì œí•˜ê³  í˜„ì¬ ê²ƒë§Œ ì„ íƒ
        document.querySelectorAll('.bbox').forEach(b => b.classList.remove('selected'));
        bbox.classList.add('selected');
        selectedBboxes = [bbox];
      }
      updateClassifyButton();
    }
    
    function updateClassifyButton() {
      const classifyBtn = document.getElementById('classifyBtn');
      if (classifyBtn) {
        if (selectedBboxes.length > 0) {
          if (selectedBboxes.length === 1) {
            classifyBtn.innerHTML = `<span>âœ“</span><span>ë¶„ë¥˜í•˜ê¸°</span>`;
          } else {
            classifyBtn.innerHTML = `<span>âœ“</span><span>${selectedBboxes.length}ê°œ ë¶„ë¥˜í•˜ê¸°</span>`;
          }
        } else {
          classifyBtn.innerHTML = '<span>âœ“</span><span>ê³¤ì¶©ì„ ì„ íƒí•´ì£¼ì„¸ìš”</span>';
        }
      }
    }

    let currentDraggingBbox = null; // í˜„ì¬ ë“œë˜ê·¸ ì¤‘ì¸ ë°”ìš´ë”© ë°•ìŠ¤

    document.addEventListener('mousemove', function(e) {
      if (selectedBboxes.length === 0) return;

      const img = originalImage;
      const imgRect = img.getBoundingClientRect();
      const containerRect = imageContainer.getBoundingClientRect();
      const scaleX = imgRect.width / img.naturalWidth;
      const scaleY = imgRect.height / img.naturalHeight;

      // ë“œë˜ê·¸í•  ë°”ìš´ë”© ë°•ìŠ¤ ê²°ì • (ì—¬ëŸ¬ ê°œ ì„ íƒëœ ê²½ìš° ë§ˆì§€ë§‰ìœ¼ë¡œ í´ë¦­í•œ ê²ƒ)
      const targetBbox = currentDraggingBbox || selectedBboxes[selectedBboxes.length - 1];

      if (isDragging && !isResizing && targetBbox) {
        const x = e.clientX - containerRect.left - dragOffset.x;
        const y = e.clientY - containerRect.top - dragOffset.y;
        
        const maxX = imgRect.width - parseFloat(targetBbox.style.width);
        const maxY = imgRect.height - parseFloat(targetBbox.style.height);
        
        targetBbox.style.left = Math.max(0, Math.min(x, maxX)) + 'px';
        targetBbox.style.top = Math.max(0, Math.min(y, maxY)) + 'px';
      } else if (isResizing && resizeHandle && targetBbox) {
        const rect = targetBbox.getBoundingClientRect();
        const containerLeft = containerRect.left;
        const containerTop = containerRect.top;
        
        let newLeft = parseFloat(targetBbox.style.left);
        let newTop = parseFloat(targetBbox.style.top);
        let newWidth = parseFloat(targetBbox.style.width);
        let newHeight = parseFloat(targetBbox.style.height);

        const mouseX = e.clientX - containerLeft;
        const mouseY = e.clientY - containerTop;

        if (resizeHandle.includes('w')) {
          const diff = mouseX - newLeft;
          newLeft = Math.max(0, mouseX);
          newWidth = Math.max(20, parseFloat(targetBbox.style.width) - diff);
        }
        if (resizeHandle.includes('e')) {
          newWidth = Math.max(20, mouseX - newLeft);
        }
        if (resizeHandle.includes('n')) {
          const diff = mouseY - newTop;
          newTop = Math.max(0, mouseY);
          newHeight = Math.max(20, parseFloat(targetBbox.style.height) - diff);
        }
        if (resizeHandle.includes('s')) {
          newHeight = Math.max(20, mouseY - newTop);
        }

        if (newLeft + newWidth > imgRect.width) {
          newWidth = imgRect.width - newLeft;
        }
        if (newTop + newHeight > imgRect.height) {
          newHeight = imgRect.height - newTop;
        }

        targetBbox.style.left = newLeft + 'px';
        targetBbox.style.top = newTop + 'px';
        targetBbox.style.width = newWidth + 'px';
        targetBbox.style.height = newHeight + 'px';
      }
    });

    document.addEventListener('mouseup', function() {
      isDragging = false;
      isResizing = false;
      resizeHandle = null;
      currentDraggingBbox = null;
    });

    function getBoundingBoxes() {
      const img = originalImage;
      const imgRect = img.getBoundingClientRect();
      const scaleX = img.naturalWidth / imgRect.width;
      const scaleY = img.naturalHeight / imgRect.height;

      // ëª¨ë“  ë°”ìš´ë”© ë°•ìŠ¤ ë°˜í™˜
      return boundingBoxes.map(bboxData => {
        const bbox = bboxData.element;
        const left = parseFloat(bbox.style.left);
        const top = parseFloat(bbox.style.top);
        const width = parseFloat(bbox.style.width);
        const height = parseFloat(bbox.style.height);

        return {
          bbox: [
            left * scaleX,
            top * scaleY,
            (left + width) * scaleX,
            (top + height) * scaleY
          ],
          confidence: bboxData.original.confidence,
          class: bboxData.original.class
        };
      });
    }

    function saveBoundingBoxes() {
      const updatedBoxes = getBoundingBoxes();
      
      fetch('/update_bboxes', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          bboxes: updatedBoxes
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('ë°”ìš´ë”© ë°•ìŠ¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
          originalBboxes = updatedBoxes;
        } else {
          alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
    }

    function resetBoundingBoxes() {
      if (confirm('ë°”ìš´ë”© ë°•ìŠ¤ë¥¼ ì›ë˜ëŒ€ë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        bboxContainer.innerHTML = '';
        boundingBoxes = [];
        initializeBoundingBoxes();
      }
    }

    function proceedToClassification() {
      const allBoxes = getBoundingBoxes();
      
      if (allBoxes.length === 0) {
        alert('ë¶„ë¥˜í•  ê³¤ì¶©ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      if (selectedBboxes.length === 0) {
        alert('ë¶„ë¥˜í•  ê³¤ì¶©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ì„ íƒëœ ë°•ìŠ¤ë“¤ì˜ ì¸ë±ìŠ¤ ì¶”ì¶œ
      const indicesToClassify = selectedBboxes.map(bbox => {
        return boundingBoxes.findIndex(b => b.element === bbox);
      }).filter(idx => idx !== -1);
      
      // ëª¨ë“  ê³¤ì¶©ì„ ìˆœì°¨ì ìœ¼ë¡œ ë¶„ë¥˜
      let currentIndex = 0;
      const classifyBtn = document.getElementById('classifyBtn');
      const originalBtnText = classifyBtn ? classifyBtn.innerHTML : '';
      
      // ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
      const loadingSpinner = document.getElementById('loadingSpinner');
      const loadingText = document.getElementById('loadingText');
      const loadingSubtext = document.getElementById('loadingSubtext');
      
      if (loadingSpinner) {
        loadingSpinner.classList.add('active');
      }
      
      const classifyNext = () => {
        if (currentIndex >= indicesToClassify.length) {
          // ëª¨ë“  ë¶„ë¥˜ ì™„ë£Œ
          if (loadingSpinner) {
            loadingText.textContent = 'ë¶„ë¥˜ ì™„ë£Œ!';
            loadingSubtext.textContent = 'ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...';
          }
          if (classifyBtn) {
            classifyBtn.innerHTML = '<span>âœ“</span><span>ë¶„ë¥˜ ì™„ë£Œ!</span>';
            classifyBtn.disabled = true;
            classifyBtn.style.textAlign = 'center';
            classifyBtn.style.justifyContent = 'center';
          }
          // ì„œë²„ê°€ ëª¨ë“  ì„¸ì…˜ì„ ì €ì¥í•  ì‹œê°„ì„ í™•ë³´í•˜ê¸° ìœ„í•´ ë”œë ˆì´ ì¶”ê°€
          setTimeout(() => {
            window.location.reload();
          }, 500);
          return;
        }
        
        const targetIndex = indicesToClassify[currentIndex];
        const progress = `(${currentIndex + 1}/${indicesToClassify.length})`;
        console.log(`ë¶„ë¥˜ ì¤‘... ${progress}`);
        
        // ê° ê³¤ì¶©ì— ëŒ€í•´ ë¶„ë¥˜ ëª¨ë¸ì„ 2ë²ˆ ì‹¤í–‰
        let classificationAttempt = 0;
        const maxAttempts = 2;
        
        const classifyWithRetry = () => {
          classificationAttempt++;
          const attemptText = maxAttempts > 1 ? ` (ì‹œë„ ${classificationAttempt}/${maxAttempts})` : '';
          
          // ì§„í–‰ ìƒí™© í‘œì‹œ
          if (loadingText) {
            loadingText.textContent = `ë¶„ë¥˜ ì¤‘... ${progress}${attemptText}`;
          }
          if (loadingSubtext) {
            loadingSubtext.textContent = 'AIê°€ ê³¤ì¶©ì˜ íŠ¹ì§•ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤';
          }
          if (classifyBtn) {
            classifyBtn.innerHTML = `<span>â³</span><span>ë¶„ë¥˜ ì¤‘... ${progress}${attemptText}</span>`;
            classifyBtn.disabled = true;
            classifyBtn.style.textAlign = 'center';
            classifyBtn.style.justifyContent = 'center';
          }
          
          fetch('/classify', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              bboxes: allBoxes,
              selected_index: targetIndex
            })
          })
          .then(response => {
            if (response.ok) {
              return response.json();
            } else {
              return response.text().then(text => {
                throw new Error(`HTTP ${response.status}: ${text}`);
              });
            }
          })
          .then(data => {
            if (data.success) {
              console.log(`ë¶„ë¥˜ ì™„ë£Œ (ì‹œë„ ${classificationAttempt}/${maxAttempts})`);
              
              // 2ë²ˆ ì‹¤í–‰ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë‹¤ì‹œ ì‹¤í–‰
              if (classificationAttempt < maxAttempts) {
                setTimeout(classifyWithRetry, 200);
              } else {
                // 2ë²ˆ ëª¨ë‘ ì™„ë£Œë˜ë©´ ë‹¤ìŒ ê³¤ì¶©ìœ¼ë¡œ
                currentIndex++;
                // ì„œë²„ê°€ ì„¸ì…˜ì„ ì €ì¥í•  ì‹œê°„ì„ í™•ë³´í•˜ê¸° ìœ„í•´ ë”œë ˆì´ ì¦ê°€
                setTimeout(classifyNext, 300);
              }
            } else {
              throw new Error(data.error || 'ë¶„ë¥˜ ì‹¤íŒ¨');
            }
          })
          .catch(error => {
            console.error(`ë¶„ë¥˜ ì˜¤ë¥˜ (ì‹œë„ ${classificationAttempt}):`, error);
            
            // ì¬ì‹œë„ ê°€ëŠ¥í•˜ë©´ ì¬ì‹œë„
            if (classificationAttempt < maxAttempts) {
              setTimeout(classifyWithRetry, 200);
            } else {
              // ìµœëŒ€ ì‹œë„ íšŸìˆ˜ì— ë„ë‹¬í–ˆìœ¼ë©´ ë‹¤ìŒ ê³¤ì¶©ìœ¼ë¡œ
              alert(`ë¶„ë¥˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
              currentIndex++;
              if (currentIndex < indicesToClassify.length) {
                setTimeout(classifyNext, 300);
              } else {
                // ëª¨ë“  ë¶„ë¥˜ ì‹œë„ ì™„ë£Œ (ì¼ë¶€ ì‹¤íŒ¨ í¬í•¨)
                if (classifyBtn) {
                  classifyBtn.innerHTML = originalBtnText;
                  classifyBtn.disabled = false;
                }
                setTimeout(() => {
                  window.location.reload();
                }, 500);
              }
            }
          });
        };
        
        classifyWithRetry();
      };
      
      classifyNext();
    }
    {% endif %}
    
    function selectCandidateTab(insectIndex, speciesName, element) {
      const tabs = document.querySelectorAll('.candidate-tab[data-insect-index="' + insectIndex + '"]');
      tabs.forEach(tab => {
        tab.style.background = 'white';
        tab.style.color = '#333';
        tab.style.borderColor = '#dee2e6';
      });
      element.style.background = '#3182F6';
      element.style.color = 'white';
      element.style.borderColor = '#3182F6';
      
      fetch('/select_candidate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          insect_index: insectIndex,
          species_name: speciesName
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          setTimeout(() => window.location.reload(), 200);
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
    }

    // UI í•¨ìˆ˜ë“¤
    function closeBanner() {
      document.getElementById('infoBanner').classList.add('hidden');
      localStorage.setItem('infoBannerClosed', 'true');
    }


    function openCamera() {
      if (imageInput && !isUploading) {
        isUploading = true;
        // ì¹´ë©”ë¼ë¡œ ì´¬ì˜í•˜ê¸° ìœ„í•´ capture ì†ì„± ì„¤ì •
        imageInput.setAttribute('capture', 'environment');
        imageInput.removeAttribute('multiple');
        imageInput.click();
        // ì§§ì€ ë”œë ˆì´ í›„ í”Œë˜ê·¸ ë¦¬ì…‹
        setTimeout(() => {
          isUploading = false;
        }, 100);
      }
    }

    function openGallery() {
      if (imageInput && !isUploading) {
        isUploading = true;
        // ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒí•˜ê¸° ìœ„í•´ capture ì†ì„± ì œê±°
        imageInput.removeAttribute('capture');
        imageInput.removeAttribute('multiple');
        imageInput.click();
        // ì§§ì€ ë”œë ˆì´ í›„ í”Œë˜ê·¸ ë¦¬ì…‹
        setTimeout(() => {
          isUploading = false;
        }, 100);
      }
    }

    function openMyPage() {
      alert('ë§ˆì´í˜ì´ì§€ëŠ” ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
    }

    // ì •ë³´ ë°°ë„ˆ ë‹«í˜ ìƒíƒœ í™•ì¸
    if (localStorage.getItem('infoBannerClosed') === 'true') {
      document.getElementById('infoBanner').classList.add('hidden');
    }
  </script>
</body>
</html>
